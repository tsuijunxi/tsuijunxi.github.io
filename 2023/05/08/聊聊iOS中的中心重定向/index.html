<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "a56087b5"
    });
  daovoice('update');
  </script>




  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Trampoline 中心重定向 InlineHook," />










<meta name="description" content="背景中心重定向，顾名思义，就是将某些流程统一流转到某个中心，然后进行一些切面操作，之后再继续回到原有后续流程。某种意义上来说，中心重定向和 iOS 中的 Hook 非常相似，但是不是同一个东西，中心重定向必须要有1个中心，而Hook可以没有。本文将通过几个例子来举例说明。 如何用 JS 语法书写 iOS？接触过 JSPatch 的同学应该对下面的代码有比较深刻的印象，看起来很像 iOS，但实际上是">
<meta name="keywords" content="Trampoline 中心重定向 InlineHook">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊iOS中的中心重定向">
<meta property="og:url" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/index.html">
<meta property="og:site_name" content="凌云的博客">
<meta property="og:description" content="背景中心重定向，顾名思义，就是将某些流程统一流转到某个中心，然后进行一些切面操作，之后再继续回到原有后续流程。某种意义上来说，中心重定向和 iOS 中的 Hook 非常相似，但是不是同一个东西，中心重定向必须要有1个中心，而Hook可以没有。本文将通过几个例子来举例说明。 如何用 JS 语法书写 iOS？接触过 JSPatch 的同学应该对下面的代码有比较深刻的印象，看起来很像 iOS，但实际上是">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/01.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/02.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/03.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/04.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/05.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/06.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/07.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/08.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/09.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/10.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/11.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/12.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/13.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/14.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/15.png">
<meta property="og:updated_time" content="2023-05-14T11:14:17.195Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="聊聊iOS中的中心重定向">
<meta name="twitter:description" content="背景中心重定向，顾名思义，就是将某些流程统一流转到某个中心，然后进行一些切面操作，之后再继续回到原有后续流程。某种意义上来说，中心重定向和 iOS 中的 Hook 非常相似，但是不是同一个东西，中心重定向必须要有1个中心，而Hook可以没有。本文将通过几个例子来举例说明。 如何用 JS 语法书写 iOS？接触过 JSPatch 的同学应该对下面的代码有比较深刻的印象，看起来很像 iOS，但实际上是">
<meta name="twitter:image" content="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/"/>





  <title>聊聊iOS中的中心重定向 | 凌云的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">凌云的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lingyun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.ico">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凌云的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">聊聊iOS中的中心重定向</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-05-08T23:40:07+08:00">
                2023-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OC/" itemprop="url" rel="index">
                    <span itemprop="name">OC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,590
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  29
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>中心重定向，顾名思义，就是将某些流程统一流转到某个中心，然后进行一些切面操作，之后再继续回到原有后续流程。某种意义上来说，中心重定向和 <code>iOS</code> 中的 <code>Hook</code> 非常相似，但是不是同一个东西，中心重定向必须要有1个中心，而<code>Hook</code>可以没有。<br>本文将通过几个例子来举例说明。<br><img src="/2023/05/08/聊聊iOS中的中心重定向/01.png" width="100%"></p>
<h1 id="如何用-JS-语法书写-iOS？"><a href="#如何用-JS-语法书写-iOS？" class="headerlink" title="如何用 JS 语法书写 iOS？"></a>如何用 JS 语法书写 iOS？</h1><p>接触过 <code>JSPatch</code> 的同学应该对下面的代码有比较深刻的印象，看起来很像 <code>iOS</code>，但实际上是 <code>JS</code> 语法。这种写法之所以可行，本质上和中心重定向有很大的关系。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'UIView'</span>) </span><br><span class="line"><span class="keyword">var</span> view = UIView.alloc().init()</span><br><span class="line">view.setBackgroundColor(<span class="built_in">require</span>(<span class="string">'UIColor'</span>).grayColor())</span><br><span class="line">view.setAlpha(<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>
<h2 id="暴力映射"><a href="#暴力映射" class="headerlink" title="暴力映射"></a>暴力映射</h2><p>根据 <code>JS</code> 特性，若要让 <code>UIView.alloc()</code> 这句调用不出错，唯一的方法就是给 <code>UIView</code> 这个对象添加 <code>alloc</code> 方法，不然是不可能调用成功的。<code>JS</code> 对于调用没定义的属性/变量，只会马上抛出异常。所以为了能调用成功，需要把类名传入 <code>OC</code>，<code>OC</code> 通过runtime方法找出这个类所有的方法返回给 <code>JS</code>，<code>JS</code> 类对象为每个方法名都生成一个函数，函数内容就是拿着方法名去 OC 调用相应方法。生成的 UIView 对象大致是这样的：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    __clsName: <span class="string">"UIView"</span>,</span><br><span class="line">    alloc: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;…&#125;,</span><br><span class="line">    beginAnimations_context: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;…&#125;,</span><br><span class="line">    setAnimationsEnabled: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;…&#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这不仅要遍历当前类的所有方法，还要循环找父类的方法直到顶层，整个继承链上的所有方法都要加到 <code>JS</code> 对象上，一个类就有几百个方法，这样把方法全部加到 <code>JS</code> 对象上，会有严重的内存暴涨问题，导致无法使用。</p>
<h2 id="c-重定向"><a href="#c-重定向" class="headerlink" title="__c 重定向"></a>__c 重定向</h2><p><code>JSPatch</code> 最终的解决方案：就是调用一个不存在方法时，能转发到一个指定函数去执行。在 <code>OC</code> 执行 <code>JS</code> 前，通过正则把所有方法调用都改成调用 <code>__c()</code> 函数，做到了类似 <code>OC/Lua/Ruby</code> 等的消息转发机制</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UIView.alloc().init()</span><br><span class="line">-&gt;</span><br><span class="line">UIView.__c(<span class="string">'alloc'</span>)().__c(<span class="string">'init'</span>)()</span><br></pre></td></tr></table></figure>
<p>给 <code>JS</code> 对象基类 <code>Object</code> 加上 <code>__c</code> 成员，这样所有对象都可以调用到 <code>__c</code>，根据当前对象类型判断进行不同操作：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">Object</span>.prototype, <span class="string">'__c'</span>, &#123;<span class="attr">value</span>: <span class="function"><span class="keyword">function</span>(<span class="params">methodName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.__obj &amp;&amp; !<span class="keyword">this</span>.__clsName) <span class="keyword">return</span> <span class="keyword">this</span>[methodName].bind(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>)</span><br><span class="line">    <span class="keyword">return</span> _methodFunc(self.__obj, self.__clsName, methodName, args, self.__isSuper)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#125;)</span><br></pre></td></tr></table></figure></p>
<p>这样做不用去 <code>OC</code> 遍历对象方法，不用在 <code>JS</code> 对象保存这些方法，通过转发达到调用所有方法的目的。<code>__c</code>成员似乎提供了一种元函数的能力，原来的函数则变成了元函数的参数，而这也正是中心重定向的魅力所在。</p>
<h1 id="登录判定中心重定向"><a href="#登录判定中心重定向" class="headerlink" title="登录判定中心重定向"></a>登录判定中心重定向</h1><p>绝大部分 <code>App</code> 中都会有登录功能，许多操作在进行前需要去判断用户是否登录，已登录的情况下才允许继续去执行操作，所以业务代码中经常可以看到这样的逻辑判断：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!AccountManager.sharedManager.isLogin) &#123;</span><br><span class="line">    <span class="comment">// 如果还没有登录，先去登录，一大堆逻辑在这里，可能还有回调等逻辑</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    [<span class="keyword">self</span> doSomethingNeedLogin];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样写代码有两个问题：</p>
<ol>
<li>要做的事情被打断了，登录回来也不会继续去这件事，需要用户二次操作，这是个比较严重的问题，尤其是对于一些付费场景。</li>
<li>代码中充斥了大量的登录逻辑判定，显得有些臃肿；一旦接口有变或者登录策略有变，所有的地方都得进行修改，难以维护。</li>
</ol>
<p>如何解决这个问题呢？我们来试一试中心重定向:  把这个复杂的判断逻辑交给代理来做，把需要判定的地方都统一重定向到代理，而这个代理则是 <code>iOS</code> 的 <code>NSProxy</code>，天然就用于转发。</p>
<h2 id="定义一次性观察者"><a href="#定义一次性观察者" class="headerlink" title="定义一次性观察者"></a>定义一次性观察者</h2><p>顾名思义，只观察1次，回调之后会进行删除，这个操作一般需要定义在登录管理器中<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addOnceLoginObserver:(<span class="keyword">id</span>)observer invocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</span><br><span class="line">    <span class="keyword">if</span> (!observer || !invocation) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_main_async_safe(^&#123;</span><br><span class="line">        [_onceLoginObserversMap setObject:invocation forKey:observer];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="登录回调"><a href="#登录回调" class="headerlink" title="登录回调"></a>登录回调</h2><ol>
<li>登录成功后，主动触发注册的NSInvocation，触发之后从一次性观察集合中移除</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)informOnceLoginObserverForSuccess &#123;</span><br><span class="line">    dispatch_main_async_safe(^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> target <span class="keyword">in</span> _onceLoginObserversMap) &#123;</span><br><span class="line">            <span class="built_in">NSInvocation</span> *invocation = [_onceLoginObserversMap objectForKey:target];</span><br><span class="line">            [invocation invokeWithTarget:target];</span><br><span class="line">        &#125;</span><br><span class="line">        [_onceLoginObserversMap removeAllObjects];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>登录失败后或者取消登录调用：</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)informOnceLoginObserverForFailure &#123;</span><br><span class="line">    [<span class="keyword">self</span> removeAllOnceLoginObserver];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="定义登录代理"><a href="#定义登录代理" class="headerlink" title="定义登录代理"></a>定义登录代理</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LoginProxy.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LoginProxy</span> : <span class="title">NSProxy</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LoginProxy</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> target;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LoginProxy.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LoginProxy</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target &#123;</span><br><span class="line">    <span class="keyword">self</span>.target = target;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</span><br><span class="line">    invocation.target = <span class="literal">nil</span>;   </span><br><span class="line">    AccountManager *accoutMgr = AccountManager.sharedManager;</span><br><span class="line">    <span class="keyword">if</span> (! accoutMgr.isLogin) &#123;</span><br><span class="line">        <span class="comment">// retain arguments</span></span><br><span class="line">        [invocation retainArguments];</span><br><span class="line">        <span class="comment">// add once observer</span></span><br><span class="line">        [accoutMgr addOnceAuthenticationObserver:<span class="keyword">self</span>.target invocation:invocation];</span><br><span class="line">        <span class="comment">// show login vc</span></span><br><span class="line">        [AccountLoginManager presentLoginViewControllerFromVC:<span class="literal">nil</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// invoke directly</span></span><br><span class="line">        [invocation invokeWithTarget:<span class="keyword">self</span>.target];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.target methodSignatureForSelector:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="定义-NSObject-分类-LoginProxy"><a href="#定义-NSObject-分类-LoginProxy" class="headerlink" title="定义 NSObject 分类 LoginProxy"></a>定义 NSObject 分类 LoginProxy</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">LoginProxy</span>)</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)loginProxy;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">LoginProxy</span>)</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)loginProxy &#123;</span><br><span class="line">    <span class="keyword">return</span> [(<span class="keyword">id</span>)[LoginProxy alloc] initWithTarget:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>这样任意一个继承自 <code>NSObject</code> 的 <code>OC</code> 对象都可以获取到自己的登录代理。</p>
<h2 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h2><p>那么原来的登录判断流程就可以写的很简洁：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.loginProxy doSomethingNeedLogin];</span><br></pre></td></tr></table></figure></p>
<ol>
<li><code>loginProxy</code> 会把当前的 <code>target</code>（这里是self）记录下来；</li>
<li><code>loginProxy</code> 由于没有实现 <code>target</code> 的方法 <code>doSomethingNeedLogin</code>，所以会走转发<code>forwardInvocation</code>；</li>
<li>在 <code>forwardInvocation</code> 会进行判断，如果已登录，直接触发 <code>invocation</code>；</li>
<li>否则，使用 <code>AccountManager</code> 将 <code>target</code> 添加到一次性观察集合中，然后去登录。<ul>
<li>如果登录成功，<code>AccountManager</code> 会使用 <code>[invocation invokeWithTarget:target]</code> 这样的方式触发 <code>doSomethingNeedLogin</code> 逻辑，然后从一次性观察者中移除 <code>target</code>；</li>
<li>如果登录失败，会直接从一次性观察者中移除 <code>target</code>，不会触发 <code>doSomethingNeedLogin</code> 逻辑；</li>
</ul>
</li>
</ol>
<p>从这个角度来看，登录中心重定向克服了前面提到的两个问题：</p>
<ol>
<li>做的事情不会被打断，登录前需要做的事情，登录回来还会继续做；</li>
<li>登录判定逻辑都统一收敛到代理，而业务侧的调用则更加简洁；</li>
</ol>
<h1 id="如何中心重定向任意一个Block？"><a href="#如何中心重定向任意一个Block？" class="headerlink" title="如何中心重定向任意一个Block？"></a>如何中心重定向任意一个Block？</h1><p>第一个示例通过脚本预处理达到了中心重定向，而第二个示例则利用了 <code>OC</code> 语言的天然特性来达到了中心重定向的效果。那么有没有更彻底一点，更底层一点，可以忽略语言特性的中心重定向呢？<br>我们知道，所有的 <code>OC</code> 方法最终都会调用到 <code>objc_msgSend</code> 家族，所以如果想重定向 <code>OC</code> 方法，只需要去 <code>hook</code> <code>objc_msgSend</code> 家族即可。那么如何去重定向任意 <code>1</code> 个 <code>Block</code> 呢？</p>
<ol>
<li><code>Block</code> 虽然本质上也是 <code>OC</code> 对象，但是它并不会走消息转发逻辑，而是类似于 <code>C</code> 方法，直接调用。</li>
<li>不同的 <code>Block</code> 的签名是不同的，参数的个数和返回值类型也是不确定的，要重定向任意一个 <code>Block</code> 会特别困难，很难从 <code>OC</code> 语言层面去解决这个问题。</li>
</ol>
<p>经过调研了解到，中心重定向汇编框架 <code>TrampolineHook</code> 可以用于拦截指定函数，在函数被调用时，收到一个回调通知。它是一个不用关注底层架构 <code>Calling Convention</code>（因为涉及到汇编），不用关心上下文信息保存、恢复，不用担心引入传统 <code>Swizzle</code> 方案在大型项目中有奇奇怪怪 <code>Crash</code> 问题的中心重定向框架。那么这个机制能不能用于 Block 的重定向呢？通过调研发现是可行的，我决定使用其原理机制，来实现一个 <code>Block</code> 的重定向框架：<code>TrampolineBlockHook</code>，并同时支持 <code>arm64</code> 和 <code>x86_64</code> 架构。</p>
<h2 id="目前效果"><a href="#目前效果" class="headerlink" title="目前效果"></a>目前效果</h2><p><code>TrampolineBlockHook</code> 提供了非常简单的 <code>API</code> 来重定向 <code>Block</code> 和撤销重定向<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> BOOL <span class="title">hook_block_with_stub</span><span class="params">(<span class="keyword">void</span> *replaced, <span class="keyword">void</span> *replacement, <span class="keyword">void</span> *pre, <span class="keyword">void</span> *post)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> BOOL <span class="title">unhook_block</span><span class="params">(<span class="keyword">void</span> *replaced)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>深入讨论之前，先看下目前的效果<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pre</span><span class="params">(<span class="keyword">void</span> *p1, <span class="keyword">void</span> *p2)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"before hook\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">void</span> *p1, <span class="keyword">void</span> *p2)</span> </span>&#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">"after hook\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)testBlockWithAll &#123;</span><br><span class="line">    __block BOOL didRun = NO;</span><br><span class="line">    Student (^Block)(id self) = ^Student (id blockself) &#123;</span><br><span class="line">        didRun = YES;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is the original block\n"</span>);</span><br><span class="line">        Student s = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Student (^ReplacedBlock)(id self) = ^Student (id blockself) &#123;</span><br><span class="line">        didRun = YES;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"this is the replaced block\n"</span>);</span><br><span class="line">        Student s = &#123;<span class="number">6</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    hook_block_with_stub((__bridge <span class="keyword">void</span> *)(Block), (__bridge <span class="keyword">void</span> *)(ReplacedBlock), pre, after);</span><br><span class="line">    Student student = Block(self);</span><br><span class="line">    NSAssert(student.height == <span class="number">2</span>, @<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">    unhook_block((__bridge <span class="keyword">void</span> *)(Block));</span><br><span class="line">    student = Block(self);</span><br><span class="line">    NSAssert(student.height == <span class="number">5</span>, @<span class="string">""</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果如图所示：<br><img src="/2023/05/08/聊聊iOS中的中心重定向/02.png" width="100%"></p>
<p><code>hook_block_with_stub</code> 方法的第 <code>2</code> 个参数可以和第 <code>1</code> 个参数相同，代表并没有替换 <code>Block</code> 的实现，只是在<code>Block</code>的前后添加了 <code>2</code>个函数插桩：<code>pre</code> 和 <code>post</code>。</p>
<h2 id="vm-remap-技术"><a href="#vm-remap-技术" class="headerlink" title="vm_remap 技术"></a>vm_remap 技术</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><code>iOS</code> 系统存在限制，我们没有权限创建可写可执行内存，但 <code>vm_remap</code> 可以间接突破这个限制。</p>
<blockquote>
<p>On Darwin, vm_remap() provides support for mapping an existing code page at new address, while retaining the existing page protections; using vm_remap(), we can create multiple copies of existing, executable code, placed at arbitrary addresses.</p>
</blockquote>
<p><code>vm_remap</code> 可以让内存页具备被 <code>map</code> 的页的特性，如果是可执行页被 <code>map</code>，那新创建的页自然而然也具备了可执行权限。 使用 <code>vm_remap</code>，我们可以创建可执行代码的多个副本，并且可以放置在任意地址。如图( 来自 <a href="http://landonf.org/code/objc/imp_implementationWithBlock.20110413.html_" target="_blank" rel="noopener">Implementing imp_implementationWithBlock()</a> )，我们可以事先编写一页可执行代码 <code>Trampoline Page</code>，在运行的时候可以可以通过 <code>vm_remap</code> 机制创建副本：<code>Trampoline Page Copy #1</code> 和 <code>Trampoline Page Copy #2</code>，用于执行代码。<br><img src="/2023/05/08/聊聊iOS中的中心重定向/03.png" width="100%"></p>
<p>然而，这仅仅解决了一半的问题。每个 <code>Trampoline Page</code>可能包含多个 <code>Trampoline Entry</code>（每有 <code>1</code> 个 <code>Block</code> 被重定向，就会有 <code>1</code> 个相应的 <code>Trampoline Entry</code>），但是这些 <code>Trampoline Entry</code> 需要一些对应的信息（例如 <code>Block</code> 的原有地址，前后的插庄函数地址等），这些信息则需要在对应的 <code>Trampoline Data</code> 页面进行配置。 如果将<code>Trampoline Data</code> 页面映射到 <code>Trampoline Page</code> 页面旁边，则可以使用 <code>PC</code> 相对寻址从相邻的 <code>Trampoline Data</code> 页加载需要的数据。如图，如果 <code>Trampoline Page Copy #1</code> 中的某个 <code>Trampoline Entry</code> 需要一些信息，则可以到 <code>Trampoline Data #1</code> 页对应的位置去加载。<br><img src="/2023/05/08/聊聊iOS中的中心重定向/04.png" width="100%"></p>
<h3 id="代码实践"><a href="#代码实践" class="headerlink" title="代码实践"></a>代码实践</h3><p><img src="/2023/05/08/聊聊iOS中的中心重定向/05.png" width="100%"></p>
<p>这里我们通过 <code>vm_allocate</code> 分配连续的两页内存，通过 <code>vm_deallocate</code> 释放第二页内存，最后通过 <code>vm_remap</code>将 <code>trampoline_page</code> 映射到第二页内存。这就构建好了我们需要的两页内存，第一页空的，用于存储一些数据信息，例如 <code>Block</code> 地址、插桩函数地址（例如 <code>pre</code> 和 <code>post</code>）等，第二页映射好了所有的动态可执行地址。反映到图中，第一页对应 <code>trampoline data page</code>，第二页对应 <code>trampoline text page</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// alloc two pages</span></span><br><span class="line"><span class="keyword">vm_address_t</span> data_page = <span class="number">0x0</span>;</span><br><span class="line"><span class="keyword">kern_return_t</span> kt;</span><br><span class="line">kt = vm_allocate (mach_task_self(), &amp;data_page, PAGE_SIZE*<span class="number">2</span>, VM_FLAGS_ANYWHERE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// drop the second half of the allocation to make room for the trampoline table</span></span><br><span class="line"><span class="keyword">vm_address_t</span> trampoline_page = data_page+PAGE_SIZE;</span><br><span class="line">kt = vm_deallocate (mach_task_self(), trampoline_page, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// remap the second half of the allocation</span></span><br><span class="line"><span class="keyword">vm_prot_t</span> cur_prot;</span><br><span class="line"><span class="keyword">vm_prot_t</span> max_prot;</span><br><span class="line">kt = vm_remap (mach_task_self(), &amp;trampoline_page, PAGE_SIZE, <span class="number">0x0</span>, FALSE, mach_task_self(), (<span class="keyword">vm_address_t</span>) config-&gt;template_page, FALSE, &amp;cur_prot, &amp;max_prot, VM_INHERIT_SHARE);</span><br></pre></td></tr></table></figure>
<p>仔细的同学会发现，第一个 <code>tramp entry1</code> 的前面有一段代码 <code>tramp dispatch</code>，这段代码的大小决定了 <code>tramp entry1</code> 的偏移。有两种方式来计算这段代码的大小，一个是手动计算，另一种是利用工具 <code>Hopper</code>。</p>
<h2 id="Block-的结构表达"><a href="#Block-的结构表达" class="headerlink" title="Block 的结构表达"></a>Block 的结构表达</h2><p>为了可以重定向任意的Block，而不用关心其参数、返回值等，需要找一种结构体来描述Block。这里可以借助<a href="https://github.com/apple-oss-distributions/libclosure/blob/main/Block_private.h" target="_blank" rel="noopener">https://github.com/apple-oss-distributions/libclosure/blob/main/Block_private.h</a> 中的Block_layout来描述。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Block_descriptor</span> &#123;</span></span><br><span class="line">    <span class="comment">/** Reserved value */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> reserved;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Total size of the described block, including imported variables. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> size;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Optional block copy helper. May be NULL. */</span></span><br><span class="line">    <span class="keyword">void</span> (*copy)(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Optional block dispose helper. May be NULL. */</span></span><br><span class="line">    <span class="keyword">void</span> (*dispose)(<span class="keyword">void</span> *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Block_layout</span> &#123;</span></span><br><span class="line">    <span class="comment">/** Pointer to the block's Objective-C class. */</span></span><br><span class="line">    <span class="keyword">void</span> *isa;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Block flags. */</span></span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Reserved value. */</span></span><br><span class="line">    <span class="keyword">int</span> reserved;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Block invocation function. */</span></span><br><span class="line">    <span class="keyword">void</span> (*invoke)(<span class="keyword">void</span> *, ...);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Shared block descriptor. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Block_descriptor</span> *<span class="title">descriptor</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// imported variables</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="流程跳转逻辑"><a href="#流程跳转逻辑" class="headerlink" title="流程跳转逻辑"></a>流程跳转逻辑</h2><ol>
<li>把一个我们要替换的 <code>Block</code> 地址 <code>A</code> 取出来，保存起来；</li>
<li>给这个 <code>Block</code> 重定向一个动态分配的可执行地址 <code>B</code>；</li>
<li>当执行这个 <code>Block</code> 的时候，会跳转到可执行地址 <code>B</code>；</li>
<li>这个 <code>B</code> 经过一段操作，可以获取到原先保存的 地址 <code>A</code>；</li>
<li>在跳转回地址 <code>A</code> 之前，跳转到 <code>pre stub</code> 做一些事情；</li>
<li>跳转到地址 <code>A</code>，执行原有逻辑；</li>
<li>执行完原有逻辑后，跳转到 <code>post stub</code> 再做一些事情。<br><img src="/2023/05/08/聊聊iOS中的中心重定向/06.png" width="100%"></li>
</ol>
<p>上述重定向之后的跳转流程中，我们需要拿到 <code>Block</code> 的 <code>pre stub</code> 和 <code>post stub</code> 信息，这些代码的地址配置在数据页面，那么我们需要在重定向的时候完成这些配置操作。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> BOOL <span class="title">hook_block_with_stub</span><span class="params">(<span class="keyword">void</span> *block, <span class="keyword">void</span> *replacement, <span class="keyword">void</span> *pre, <span class="keyword">void</span> *post)</span> </span>&#123;</span><br><span class="line">    trampoline *tramp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Block_layout</span> *<span class="title">bl</span> = (<span class="title">struct</span> <span class="title">Block_layout</span> *)<span class="title">block</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (bl-&gt;flags &amp; BLOCK_USE_STRET) &#123;</span><br><span class="line">        tramp = trampoline_alloc(&amp;STRET_TABLE_CONFIG, &amp;STRET_TABLE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tramp = trampoline_alloc(&amp;blockimp_table_page_config, &amp;blockimp_table);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Block_layout</span> *<span class="title">layout</span> = (<span class="title">struct</span> <span class="title">Block_layout</span>*)<span class="title">block</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Block_layout</span> *<span class="title">layoutReplaced</span> = (<span class="title">struct</span> <span class="title">Block_layout</span>*)<span class="title">replacement</span>;</span></span><br><span class="line">    <span class="keyword">void</span> **config = (<span class="keyword">void</span> **)trampoline_data_ptr(tramp-&gt;trampoline);</span><br><span class="line">    config[<span class="number">0</span>] = Block_copy(replacement);</span><br><span class="line">    config[<span class="number">1</span>] = tramp;</span><br><span class="line">    config[<span class="number">2</span>] = layoutReplaced-&gt;invoke;</span><br><span class="line">    config[<span class="number">3</span>] = pre;</span><br><span class="line">    config[<span class="number">4</span>] = post;</span><br><span class="line">    layout-&gt;descriptor-&gt;reserved = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)layout-&gt;invoke;</span><br><span class="line">    layout-&gt;invoke = (<span class="keyword">void</span> (*)(<span class="keyword">void</span> *, ...))tramp-&gt;trampoline;</span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>红色区域即相关数据，代表 <code>1</code> 个 <code>tramp data</code> ：包含 <code>5</code> 个槽，依次放置 <code>ReplacedBlock</code> 、<code>tramp</code> 、<code>ReplacedBlock-&gt;invoke</code>、<code>pre</code> 和 <code>post</code>。<br>另外我们需要将原 <code>Block</code> 的 <code>invoke</code> 指针指向代码区的 <code>tramp entry</code>，这样 <code>Block</code> 执行的时候就可以直接跳转过去。同时为了能够正常撤销重定向，需要将 原 <code>Block</code> 原先的实现逻辑保存下来，正好这里可以借助于 <code>layout-&gt;descriptor-&gt;reserved</code> 字段来存放。</p>
<p>重定向之后，如果想撤销重定向，则很容易理解<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">unhook_block</span><span class="params">(<span class="keyword">void</span> *block)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Block_layout</span> *<span class="title">layout</span> = (<span class="title">struct</span> <span class="title">Block_layout</span>*)<span class="title">block</span>;</span></span><br><span class="line">    <span class="keyword">void</span> **config = trampoline_data_ptr(layout-&gt;invoke);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Block_layout</span> *<span class="title">bl</span> = <span class="title">config</span>[0];</span></span><br><span class="line">    trampoline *tramp = config[<span class="number">1</span>];</span><br><span class="line">    layout-&gt;invoke = (<span class="keyword">void</span> (*)(<span class="keyword">void</span> *, ...))layout-&gt;descriptor-&gt;reserved;</span><br><span class="line">    layout-&gt;descriptor-&gt;reserved = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (bl-&gt;flags &amp; BLOCK_USE_STRET) &#123;</span><br><span class="line">        trampoline_free(&amp;STRET_TABLE, tramp);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        trampoline_free(&amp;blockimp_table, tramp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="arm64-汇编实现"><a href="#arm64-汇编实现" class="headerlink" title="arm64 汇编实现"></a>arm64 汇编实现</h2><p>那么接下来最关键的就是汇编中怎么处理这些跳转逻辑</p>
<h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p>先简单温习下 <code>arm64</code> 的寄存器基础<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- x0 - x7：用于传递子程序参数和结果，使用时不需要保存，多余参数采用堆栈传递，子程序返回结果写入到 x0</span><br><span class="line">- x8：用于保存子程序返回地址</span><br><span class="line">- x9 - x15：临时寄存器</span><br><span class="line">- x16 - x17：子程序内部调用寄存器</span><br><span class="line">- x18：平台寄存器，它的使用与平台相关</span><br><span class="line">- x19 - x28：临时寄存器</span><br><span class="line">- x29：帧指针寄存器 fp（栈底指针），用于连接栈帧</span><br><span class="line">- x30：链接寄存器 lr，保存了子程序返回的地址</span><br><span class="line">- x31：堆栈指针寄存器 sp</span><br></pre></td></tr></table></figure></p>
<h3 id="汇编代码"><a href="#汇编代码" class="headerlink" title="汇编代码"></a>汇编代码</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">#if</span> defined(__arm64__)</span><br><span class="line"></span><br><span class="line"># save caller register</span><br><span class="line"><span class="symbol">.macro</span> save_register</span><br><span class="line"><span class="symbol">stp</span> <span class="built_in">q0</span>,  <span class="built_in">q1</span>,   [<span class="built_in">sp</span>, #-<span class="number">32</span>]!</span><br><span class="line"><span class="symbol">stp</span> <span class="built_in">q2</span>,  <span class="built_in">q3</span>,   [<span class="built_in">sp</span>, #-<span class="number">32</span>]!</span><br><span class="line"><span class="symbol">stp</span> <span class="built_in">q4</span>,  <span class="built_in">q5</span>,   [<span class="built_in">sp</span>, #-<span class="number">32</span>]!</span><br><span class="line"><span class="symbol">stp</span> <span class="built_in">q6</span>,  <span class="built_in">q7</span>,   [<span class="built_in">sp</span>, #-<span class="number">32</span>]!</span><br><span class="line"><span class="symbol">stp</span> <span class="built_in">lr</span>,  x10,  [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br><span class="line"><span class="symbol">stp</span> x0,  x1,   [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br><span class="line"><span class="symbol">stp</span> x2,  x3,   [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br><span class="line"><span class="symbol">stp</span> x4,  x5,   [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br><span class="line"><span class="symbol">stp</span> x6,  x7,   [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br><span class="line"><span class="symbol">stp</span> x8,  x12,  [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br><span class="line"><span class="symbol">.endm</span></span><br><span class="line"></span><br><span class="line"># load caller register</span><br><span class="line"><span class="symbol">.macro</span> load_register</span><br><span class="line"><span class="symbol">ldp</span> x8,  x12,  [<span class="built_in">sp</span>], <span class="number">#16</span></span><br><span class="line"><span class="symbol">ldp</span> x6,  x7,   [<span class="built_in">sp</span>], <span class="number">#16</span></span><br><span class="line"><span class="symbol">ldp</span> x4,  x5,   [<span class="built_in">sp</span>], <span class="number">#16</span></span><br><span class="line"><span class="symbol">ldp</span> x2,  x3,   [<span class="built_in">sp</span>], <span class="number">#16</span></span><br><span class="line"><span class="symbol">ldp</span> x0,  x1,   [<span class="built_in">sp</span>], <span class="number">#16</span></span><br><span class="line"><span class="symbol">ldp</span> <span class="built_in">lr</span>,  x10,  [<span class="built_in">sp</span>], <span class="number">#16</span></span><br><span class="line"><span class="symbol">ldp</span> <span class="built_in">q6</span>,  <span class="built_in">q7</span>,   [<span class="built_in">sp</span>], <span class="number">#32</span></span><br><span class="line"><span class="symbol">ldp</span> <span class="built_in">q4</span>,  <span class="built_in">q5</span>,   [<span class="built_in">sp</span>], <span class="number">#32</span></span><br><span class="line"><span class="symbol">ldp</span> <span class="built_in">q2</span>,  <span class="built_in">q3</span>,   [<span class="built_in">sp</span>], <span class="number">#32</span></span><br><span class="line"><span class="symbol">ldp</span> <span class="built_in">q0</span>,  <span class="built_in">q1</span>,   [<span class="built_in">sp</span>], <span class="number">#32</span></span><br><span class="line"><span class="symbol">.endm</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">.text</span></span><br><span class="line"><span class="symbol">.align</span> <span class="number">14</span></span><br><span class="line"><span class="symbol">.globl</span> _blockimp_table_page</span><br><span class="line"><span class="symbol">_blockimp_table_page</span>:</span><br><span class="line"></span><br><span class="line"><span class="symbol">_block_tramp_dispatch</span>:</span><br><span class="line"></span><br><span class="line"># trampoline <span class="keyword">address+8 </span>is in <span class="built_in">lr</span></span><br><span class="line"><span class="keyword">sub </span>x12, <span class="built_in">lr</span>, <span class="number">#0x8</span></span><br><span class="line"><span class="keyword">sub </span>x12, x12, <span class="number">#0x4000</span></span><br><span class="line"></span><br><span class="line"># save x12, which represents the tramp <span class="meta">data</span> of <span class="keyword">Block</span></span><br><span class="line"><span class="keyword">str </span>x12, [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br><span class="line"></span><br><span class="line"># save <span class="built_in">lr</span> value which is in x13 rightnow</span><br><span class="line"><span class="keyword">str </span>x13, [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br><span class="line"></span><br><span class="line"># <span class="meta">get</span> the <span class="keyword">address </span>of pre stub</span><br><span class="line"><span class="keyword">ldr </span>x13, [x12, <span class="number">#0x18</span>]</span><br><span class="line"><span class="keyword">cbz </span>x13, <span class="keyword">block</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"># </span>execute the pre stub</span><br><span class="line"><span class="symbol">pre</span>:</span><br><span class="line"><span class="symbol">save_register</span></span><br><span class="line"><span class="keyword">blr </span>x13</span><br><span class="line"><span class="symbol">load_register</span></span><br><span class="line"></span><br><span class="line"># execute the original <span class="keyword">block </span>logic</span><br><span class="line"><span class="keyword">block:</span></span><br><span class="line"><span class="keyword">ldr </span>x13, [x12, <span class="number">#0x10</span>]</span><br><span class="line"><span class="keyword">blr </span>x13</span><br><span class="line"></span><br><span class="line"># execute the post stub</span><br><span class="line"><span class="keyword">ldr </span>x12, [<span class="built_in">sp</span>], <span class="number">#16</span></span><br><span class="line"><span class="keyword">ldr </span>x13, [x12, <span class="number">#0x20</span>]</span><br><span class="line"><span class="keyword">cbz </span>x13, <span class="meta">end</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">post</span>:</span><br><span class="line"><span class="symbol">save_register</span></span><br><span class="line"><span class="keyword">blr </span>x13</span><br><span class="line"><span class="symbol">load_register</span></span><br><span class="line"></span><br><span class="line"># load <span class="built_in">lr</span> value from [<span class="built_in">sp</span>]</span><br><span class="line"><span class="symbol">end</span>:</span><br><span class="line"><span class="keyword">ldr </span>x13, [<span class="built_in">sp</span>], <span class="number">#0x10</span></span><br><span class="line"><span class="keyword">br </span>x13</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">.rept</span> <span class="number">404</span></span><br><span class="line"># save <span class="built_in">lr</span> value to x13</span><br><span class="line"><span class="keyword">mov </span>x13, <span class="built_in">lr</span></span><br><span class="line"># jump to _block_tramp_dispatch</span><br><span class="line"><span class="keyword">bl </span>_block_tramp_dispatch<span class="comment">;</span></span><br><span class="line"><span class="symbol">.rept</span> <span class="number">8</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">.endr</span></span><br><span class="line"><span class="keyword">.endr</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">#endif</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>在 arm64 中，一页是 0x4000，也就是 16KB，这里 .align 14 来确保<br>在 arm64 中，每行指令无论长短，一律为4个字节</p>
</blockquote>
<p>接下来我们将逐行解释：</p>
<ol>
<li><p>由于 <code>Block</code> 被重定向到 <code>tramp entry</code>（81~87行），所以 <code>Block</code> 的调用会跳转到 <code>81</code> 行（这里假设是第 <code>1</code> 个被重定向的 <code>Block</code>，因为 <code>81</code>行 ~ <code>87</code>行的外面包着 <code>.rept</code> 指令，会重复 <code>404</code> 次）。为什么要重复 <code>404</code> 次呢？这是通过计算得到的：每个页面的大小 <code>16KB=16384B</code>，减去偏移 <code>224B</code>，每个 <code>tramp entry</code> 的大小为 <code>40B</code>，那么就 <code>(16384-224) / 40 = 404</code>。也就是说每个页面可以容纳 <code>404</code> 个 <code>Block</code> 被重定向。</p>
</li>
<li><p>代码 <code>81~87</code> 行实际上展开如下所示，总共占 <code>40</code> 个字节。此时 <code>lr</code> 寄存器保存了 <code>Block</code> 之后的地址，执行完汇编代码我们要能跳回去，所以这个地址需要保存下来，这里保存到 <code>x13</code> 寄存器。然后跳转到 <code>_block_tramp_dispatch</code>。为什么后续要跟着 <code>8</code> 个 <code>nop</code>？这是由于每个 <code>tramp data</code> 的大小是 <code>40</code> 字节，为了使得每个 <code>tramp data</code> 和每个 <code>tramp entry</code> 的大小和偏移都一一对应，所以这里需要凑够 <code>40</code>个字节，每个指令 <code>4</code> 个字节，所以一共需要 <code>10</code> 个指令</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov </span>x13, <span class="built_in">lr</span></span><br><span class="line"><span class="keyword">bl </span>_block_tramp_dispatch<span class="comment">;</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">nop</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>39~40</code> 行，由于是从 <code>83</code> 行跳转过来的，所以此时 <code>lr</code> 里面存着 <code>84</code> 行的地址。<code>lr</code> 减去 <code>8</code> 则为 <code>81</code> 行地址，<code>81</code> 行地址减去一个页面大小 <code>#0x4000</code>，则为对应的数据页面的 <code>tramp data</code> 地址。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sub </span>x12, <span class="built_in">lr</span>, <span class="number">#0x8</span></span><br><span class="line"><span class="keyword">sub </span>x12, x12, <span class="number">#0x4000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>43</code> 行，将刚刚计算的 <code>tramp data</code> 地址存储到栈帧上</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">str </span>x12, [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>46</code> 行，<code>x13</code> 寄存器此时存着 <code>Block</code> 之后的地址，这里也把它存储到栈帧上。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">str </span>x13, [<span class="built_in">sp</span>, #-<span class="number">16</span>]!</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>49~50</code>行，<code>x12</code> 寄存器存着 <code>tramp data</code>，<code>tramp data</code> 地址偏移 <code>24</code> 个字节，取出 <code>pre stub</code> 的地址，进行判空，如果为空，直接跳转到 <code>block</code> 标签。这里为什么是 <code>24</code> 个字节呢？可以看到我们在重定向的时候，把 <code>pre</code> 放到了 <code>config[3]</code>，前面的 <code>config[0]~config[2]</code>，每个占 <code>8</code> 个字节，一共 <code>24</code> 个字节，所以需要偏移 <code>24</code> 个字节。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldr </span>x13, [x12, <span class="number">#0x18</span>]</span><br><span class="line"><span class="keyword">cbz </span>x13, <span class="keyword">block</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>53~56</code> 行，此时 <code>x13</code> 寄存器保存着 <code>pre</code> 的地址，<code>blr</code> 可以直接跳转调用。但是汇编过程中调用别的函数时，需要保存 <code>caller save</code> 寄存器，调用完毕后，需要恢复 <code>caller save</code> 寄存器。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">pre</span>:</span><br><span class="line"><span class="symbol">save_register</span></span><br><span class="line"><span class="keyword">blr </span>x13</span><br><span class="line"><span class="symbol">load_register</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>59~61</code> 行，<code>x12</code> 寄存器存着 <code>tramp data</code>，<code>tramp data</code> 地址偏移 <code>16</code> 个字节，则为 <code>Block</code> 的原先实现地址，加载到 <code>x13</code> 寄存器，直接跳转。注意这里我们并没有保存和恢复caller save 寄存器，主要是因为这里要保持和重定向之前相同的现场：想想看，如果原来的Block返回某个值，我们也希望被重定向之后，还能返回相同的值。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">block:</span></span><br><span class="line"><span class="keyword">ldr </span>x13, [x12, <span class="number">#0x10</span>]</span><br><span class="line"><span class="keyword">blr </span>x13</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>64~71</code> 行，重新从栈帧中把 <code>tramp data</code> 地址加载到 <code>x12</code>，<code>x12</code> 寄存器存着 <code>tramp data</code>，<code>tramp data</code> 地址偏移 <code>32</code> 个字节，则为 <code>post</code> 的地址。接下来的调用类似于 <code>pre</code>，不再赘述。这里为什么要重新加载<code>tramp data</code> 呢？主要是因为上一步 <code>block</code> 的调用没有保存 <code>caller save</code> 寄存器，可能会破坏掉 <code>x12</code> 中的值。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ldr </span>x12, [<span class="built_in">sp</span>], <span class="number">#16</span></span><br><span class="line"><span class="keyword">ldr </span>x13, [x12, <span class="number">#0x20</span>]</span><br><span class="line"><span class="keyword">cbz </span>x13, <span class="meta">end</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">post</span>:</span><br><span class="line"><span class="symbol">save_register</span></span><br><span class="line"><span class="keyword">blr </span>x13</span><br><span class="line"><span class="symbol">load_register</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>74~76</code> 行，把 <code>Block</code> 后面的地址从栈帧中加载到 <code>x13</code> 寄存器，然后进行跳转。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">end</span>:</span><br><span class="line"><span class="keyword">ldr </span>x13, [<span class="built_in">sp</span>], <span class="number">#0x10</span></span><br><span class="line"><span class="keyword">br </span>x13</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Hopper示意图"><a href="#Hopper示意图" class="headerlink" title="Hopper示意图"></a>Hopper示意图</h3><p><img src="/2023/05/08/聊聊iOS中的中心重定向/07.png" width="100%"><br><img src="/2023/05/08/聊聊iOS中的中心重定向/08.png" width="100%"></p>
<p>仔细观察，会发现左图中 <code>_block_tramp_dispatch</code> 的地址为 <code>0x0000000000008000</code>，是一个页面的首地址，同时从右图中可以看到首个 <code>tramp entry</code> 的地址为 <code>0x00000000000080e0</code>，那么偏移为 <code>0xE0</code>，正好是前面提到的<code>224</code>。</p>
<h2 id="x86-64-汇编实现"><a href="#x86-64-汇编实现" class="headerlink" title="x86_64 汇编实现"></a>x86_64 汇编实现</h2><h3 id="寄存器-1"><a href="#寄存器-1" class="headerlink" title="寄存器"></a>寄存器</h3><p><img src="/2023/05/08/聊聊iOS中的中心重定向/09.png" width="100%"></p>
<p><hr><br><img src="/2023/05/08/聊聊iOS中的中心重定向/10.png" width="100%"></p>
<h3 id="汇编代码-1"><a href="#汇编代码-1" class="headerlink" title="汇编代码"></a>汇编代码</h3><blockquote>
<p>在 x86_64 中，一页是 0x1000，也就是 4KB，所以首先就是 .align 12 来确保<br>在 x86_64 中，指令的大小是不固定的。</p>
</blockquote>
<p><code>x86_64</code> 的汇编代码逻辑和 <code>arm64</code> 的逻辑基本一致，这里就不再逐行展开</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.macro</span> save_register</span><br><span class="line"><span class="keyword">push</span> %rdi</span><br><span class="line"><span class="keyword">push</span> %rsi</span><br><span class="line"><span class="keyword">push</span> %rdx</span><br><span class="line"><span class="keyword">push</span> %rcx</span><br><span class="line"><span class="keyword">push</span> %r8</span><br><span class="line"><span class="keyword">push</span> %r9</span><br><span class="line"><span class="keyword">push</span> %r10</span><br><span class="line"><span class="keyword">push</span> %r11</span><br><span class="line"><span class="keyword">push</span> %rax</span><br><span class="line"><span class="keyword">push</span> %rax # you may </span><br><span class="line"><span class="meta">.endm</span></span><br><span class="line"></span><br><span class="line"><span class="meta">.macro</span> load_register</span><br><span class="line"><span class="keyword">pop</span> %rax</span><br><span class="line"><span class="keyword">pop</span> %rax</span><br><span class="line"><span class="keyword">pop</span> %r11</span><br><span class="line"><span class="keyword">pop</span> %r10</span><br><span class="line"><span class="keyword">pop</span> %r9</span><br><span class="line"><span class="keyword">pop</span> %r8</span><br><span class="line"><span class="keyword">pop</span> %rcx</span><br><span class="line"><span class="keyword">pop</span> %rdx</span><br><span class="line"><span class="keyword">pop</span> %rsi</span><br><span class="line"><span class="keyword">pop</span> %rdi</span><br><span class="line"><span class="meta">.endm</span></span><br><span class="line"></span><br><span class="line"><span class="meta">.text</span></span><br><span class="line"><span class="meta">.align</span> <span class="number">12</span></span><br><span class="line"><span class="meta">.globl</span> _blockimp_table_page</span><br><span class="line"><span class="symbol">_blockimp_table_page:</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">_block_tramp_dispatch:</span></span><br><span class="line"># save the <span class="built_in">rip</span> to <span class="built_in">r11</span></span><br><span class="line"><span class="keyword">movq</span> (%rsp), %r11</span><br><span class="line"></span><br><span class="line">subq <span class="number">$0</span>x20, %rsp</span><br><span class="line"></span><br><span class="line"># calculate the address of the tramp data of Block</span><br><span class="line"><span class="keyword">sub</span> <span class="number">$0</span>x5,  %r11</span><br><span class="line"><span class="keyword">sub</span> <span class="number">$0</span>x1000, %r11</span><br><span class="line"></span><br><span class="line"># the address of the tramp data of Block to stack</span><br><span class="line"><span class="keyword">movq</span> %r11, <span class="number">0x8</span>(%rsp)</span><br><span class="line"></span><br><span class="line"># get the address of pre stub</span><br><span class="line"><span class="keyword">mov</span> <span class="number">0x18</span>(%r11), %r10</span><br><span class="line"><span class="keyword">cmp</span> <span class="number">$0</span>x0, %r10</span><br><span class="line"><span class="keyword">je</span> block</span><br><span class="line"></span><br><span class="line"># execute the pre stub</span><br><span class="line"><span class="symbol">pre:</span></span><br><span class="line">save_register</span><br><span class="line"><span class="keyword">call</span> *%r10</span><br><span class="line">load_register</span><br><span class="line"></span><br><span class="line"># execute the block</span><br><span class="line"><span class="symbol">block:</span></span><br><span class="line"><span class="keyword">call</span> *<span class="number">0x10</span>(%r11)</span><br><span class="line"></span><br><span class="line"><span class="keyword">movq</span> <span class="number">0x8</span>(%rsp), %r11</span><br><span class="line"><span class="keyword">movq</span> <span class="number">0x20</span>(%r11), %r10</span><br><span class="line">cmpq <span class="number">$0</span>x0, %r10</span><br><span class="line"><span class="keyword">je</span> end</span><br><span class="line"></span><br><span class="line"># exeute the post stub</span><br><span class="line"><span class="symbol">after:</span></span><br><span class="line">save_register</span><br><span class="line"><span class="keyword">call</span> *%r10</span><br><span class="line">load_register</span><br><span class="line"></span><br><span class="line"><span class="symbol">end:</span></span><br><span class="line">addq <span class="number">$0</span>x20, %rsp</span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"><span class="meta">.align</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"># trampoline entry</span><br><span class="line"><span class="meta">.rept</span> <span class="number">256</span></span><br><span class="line"><span class="keyword">call</span> _block_tramp_dispatch # <span class="number">5</span> bytes</span><br><span class="line"><span class="meta">.rept</span> <span class="number">34</span></span><br><span class="line"><span class="keyword">nop</span></span><br><span class="line"><span class="meta">.endr</span></span><br><span class="line"><span class="keyword">ret</span></span><br><span class="line"><span class="meta">.endr</span></span><br></pre></td></tr></table></figure>
<h3 id="Hopper示意图-1"><a href="#Hopper示意图-1" class="headerlink" title="Hopper示意图"></a>Hopper示意图</h3><p><img src="/2023/05/08/聊聊iOS中的中心重定向/11.png" width="100%"><br><img src="/2023/05/08/聊聊iOS中的中心重定向/12.png" width="100%"></p>
<h3 id="栈的对齐问题（坑点）"><a href="#栈的对齐问题（坑点）" class="headerlink" title="栈的对齐问题（坑点）"></a>栈的对齐问题（坑点）</h3><p>如图，在调试过程中，<code>x86_64</code> 经常会崩溃到 <code>SSE</code> 指令，例如 <code>movaps</code> 指令，十分诡异</p>
<p><img src="/2023/05/08/聊聊iOS中的中心重定向/13.png" width="100%"></p>
<p>通过排查最终定位到是栈的字节对齐问题，在文档 <a href="https://jyywiki.cn/pages/OS/manuals/sysv-abi.pdf" target="_blank" rel="noopener">https://jyywiki.cn/pages/OS/manuals/sysv-abi.pdf</a> 有提到：</p>
<blockquote>
<p>The end of the input argument area shall be aligned on a 16 (32 or 64, if<br><strong>m256 or </strong>m512 is passed on stack) byte boundary. In other words, the value<br>(%rsp + 8) is always a multiple of 16 (32 or 64) when control is transferred to<br>the function entry point. The stack pointer, %rsp, always points to the end of the<br>latest allocated stack frame.</p>
</blockquote>
<p><img src="/2023/05/08/聊聊iOS中的中心重定向/14.png" width="100%"></p>
<p><code>System V AMD64</code> 调用约定要求栈必须按 <code>16</code> 字节对齐，也就是说，在调用 <code>call</code> 指令之前，<code>%rsp</code> 指针必须是<code>16</code> 的倍数（对应 <code>16</code> 进制是最后1位是0）。按 <code>16</code> 字节对齐的原因是，现代<code>x86_64</code> 计算机引入了 <code>SSE</code> 和<br><code>AVX</code> 指令，这些指令支持 <code>SIMD</code>，能极大提升处理速度。但是这些指令要求必须从 <code>16</code> 字节的整数倍的地址处取数据，为了顾及这些指令，才有了上述对齐要求。</p>
<p>回到上述崩溃点，打印一下寄存器的值，发现 <code>movaps</code> 指令涉及到的 <code>rbp</code> 寄存器的值为：<code>0x7ff7bac48f98</code>，没有按照 <code>16</code> 字节对齐，偏移 <code>-0x30</code>，仍然不会按照 <code>16</code> 字节对齐。通过进一步排查发现是由于保存 <code>caller-save</code> 寄存器的时候，入栈了奇数个寄存器，导致栈的地址没有按照 <code>16</code> 字节对齐。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.macro</span> save_register</span><br><span class="line"><span class="keyword">push</span> %rdi</span><br><span class="line"><span class="keyword">push</span> %rsi</span><br><span class="line"><span class="keyword">push</span> %rdx</span><br><span class="line"><span class="keyword">push</span> %rcx</span><br><span class="line"><span class="keyword">push</span> %r8</span><br><span class="line"><span class="keyword">push</span> %r9</span><br><span class="line"><span class="keyword">push</span> %r10</span><br><span class="line"><span class="keyword">push</span> %r11</span><br><span class="line"><span class="keyword">push</span> %rax</span><br><span class="line"><span class="meta">.endm</span></span><br></pre></td></tr></table></figure>
<p>解决方案也很简单，再压入1个寄存器，把第10行重复1次即可。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.macro</span> save_register</span><br><span class="line"><span class="keyword">push</span> %rdi</span><br><span class="line"><span class="keyword">push</span> %rsi</span><br><span class="line"><span class="keyword">push</span> %rdx</span><br><span class="line"><span class="keyword">push</span> %rcx</span><br><span class="line"><span class="keyword">push</span> %r8</span><br><span class="line"><span class="keyword">push</span> %r9</span><br><span class="line"><span class="keyword">push</span> %r10</span><br><span class="line"><span class="keyword">push</span> %r11</span><br><span class="line"><span class="keyword">push</span> %rax</span><br><span class="line"><span class="keyword">push</span> %rax</span><br><span class="line"><span class="meta">.endm</span></span><br></pre></td></tr></table></figure></p>
<h3 id="为什么没有保存和恢复xmm0-xmm7"><a href="#为什么没有保存和恢复xmm0-xmm7" class="headerlink" title="为什么没有保存和恢复xmm0~xmm7?"></a>为什么没有保存和恢复xmm0~xmm7?</h3><p><img src="/2023/05/08/聊聊iOS中的中心重定向/15.png" width="100%"></p>
<p>仔细的同学会发现x86_64汇编并没有保存浮点寄存器，目前的现状是在xcode中提示语法不支持，暂时还没有找到好的办法。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p><code>TrampolineHook</code> 中心化重定向机制可以用来做很多事情：</p>
<ol>
<li>例如苹果自身的 <code>imp_implementationWithBlock</code> 就是基于该技术实现的，</li>
<li>比如苹果著名的 <code>MainThreadChecker</code> 也用了类似的技术。</li>
</ol>
<p>本文实现的 <code>TrampolineBlockHook</code> 相当于在 <code>Block</code> 的前后做了 <code>2</code> 个函数插桩：<code>pre</code> 和 <code>post</code>，围绕这 <code>2</code> 个插桩可以做很多事情，之后也将围绕这些方向点展开应用：</p>
<ol>
<li>统计 <code>Block</code> 的耗时</li>
<li>给 <code>Block</code> 添加日志</li>
<li>埋点统计等</li>
</ol>
<p>同时，<code>TrampolineBlockHook</code> 现在也还存在着一些问题，例如多线程问题、例如还没有经过大项目的实践，这些也都需要持续得打磨。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>文中聊到的几个中心重定向示例，虽然技术原理不曾相同，但是思想是相通的，而其中最关键的就是在于流转技术的实现。本文也是在实践<code>TrampolineBlockHook</code> 的时候有感而发，潦草落笔。另外在支持 <code>x86_64</code> 架构的时候的确碰到了比较严重的崩溃问题，走了不少弯路，正好也借此文档做个笔记。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ol>
<li><a href="https://zhuanlan.zhihu.com/p/107455887" target="_blank" rel="noopener">x86_64架构下的函数调用及栈帧原理</a></li>
<li><a href="https://blog.csdn.net/qq_29328443/article/details/107232025" target="_blank" rel="noopener">x86_64汇编之四：函数调用、调用约定</a></li>
<li><a href="https://mp.weixin.qq.com/s/7G0IV97xHcbdhb4vjHRJLw" target="_blank" rel="noopener">GCC汇编语法与Intel汇编语法的几个差异点</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/27339191" target="_blank" rel="noopener">x86-64 下函数调用及栈帧原理</a></li>
<li><a href="https://juejin.cn/post/6844904038564102151" target="_blank" rel="noopener">静态拦截iOS对象方法调用的简易实现</a></li>
<li><a href="https://leylfl.github.io/2018/05/15/%E6%B5%85%E8%B0%88ARM64%E6%B1%87%E7%BC%96/0" target="_blank" rel="noopener">浅谈ARM64汇编</a></li>
<li><a href="https://satanwoo.github.io/2020/04/22/NewBridgeHook/" target="_blank" rel="noopener">基于桥的全量方法 Hook 方案（2） - 全新升级</a></li>
<li><a href="https://satanwoo.github.io/2020/04/26/TrampolineHookOpenSource/" target="_blank" rel="noopener">基于桥的全量方法 Hook 方案（3）- TrampolineHook</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/130680057" target="_blank" rel="noopener">为什么使用汇编可以 Hook objectivec_msgSend（上）- 汇编基础</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/167924620" target="_blank" rel="noopener">为什么使用汇编可以 Hook objc_msgSend（下）- 实现与分析</a></li>
<li><a href="https://www.cnblogs.com/tcctw/p/11333743.html" target="_blank" rel="noopener">x86_64 Linux 运行时栈的字节对齐</a></li>
<li><a href="https://github.com/g0dA/linuxStack/" target="_blank" rel="noopener">https://github.com/g0dA/linuxStack/</a></li>
<li><a href="https://github.com/bang590/JSPatch/wiki/" target="_blank" rel="noopener">https://github.com/bang590/JSPatch/wiki/</a></li>
<li><a href="http://seanchense.github.io/2019/12/04/block-flags/" target="_blank" rel="noopener">http://seanchense.github.io/2019/12/04/block-flags/</a></li>
<li><a href="https://clang.llvm.org/docs/Block-ABI-Apple.html" target="_blank" rel="noopener">https://clang.llvm.org/docs/Block-ABI-Apple.html</a></li>
<li>Guide to x86-64</li>
<li><a href="https://juejin.cn/post/6844904098580398087" target="_blank" rel="noopener">https://juejin.cn/post/6844904098580398087</a></li>
<li><a href="https://blog.csdn.net/Desgard_Duan/article/details/107829106" target="_blank" rel="noopener">https://blog.csdn.net/Desgard_Duan/article/details/107829106</a></li>
<li><a href="https://nickdesaulniers.github.io/blog/2014/04/18/lets-write-some-x86-64/" target="_blank" rel="noopener">https://nickdesaulniers.github.io/blog/2014/04/18/lets-write-some-x86-64/</a></li>
<li><a href="https://evian-zhang.github.io/index.html" target="_blank" rel="noopener">https://evian-zhang.github.io/index.html</a></li>
<li><a href="https://en.wikipedia.org/wiki/X86_calling_conventions#System_V_AMD64_ABI" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/X86_calling_conventions#System_V_AMD64_ABI</a></li>
<li><a href="https://juejin.cn/post/6988867705637961742" target="_blank" rel="noopener">https://juejin.cn/post/6988867705637961742</a></li>
<li><a href="https://satanwoo.github.io/2017/04/23/ARM64IndirectReturn/" target="_blank" rel="noopener">https://satanwoo.github.io/2017/04/23/ARM64IndirectReturn/</a></li>
<li><a href="https://landonf.org/code/objc/imp_implementationWithBlock.20110413.html" target="_blank" rel="noopener">https://landonf.org/code/objc/imp_implementationWithBlock.20110413.html</a></li>
<li><a href="https://opensource.apple.com/source/libclosure/" target="_blank" rel="noopener">https://opensource.apple.com/source/libclosure/</a></li>
<li><a href="https://docs.oracle.com/cd/E19120-01/open.solaris/817-5477/eojde/index.html" target="_blank" rel="noopener">https://docs.oracle.com/cd/E19120-01/open.solaris/817-5477/eojde/index.html</a></li>
</ol>

      
    </div>
    
    
    

    
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束 感谢您的阅读-------------</div>
    
</div>

      <div>
    

    
      <div>
        
<div class="my_post_copyright">
  <script src="//s0.pstatp.com/cdn/expire-1-M/clipboard.js/1.5.10/clipboard.min.js"></script>
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://s1.pstatp.com/cdn/expire-1-M/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2023/05/08/聊聊iOS中的中心重定向/">聊聊iOS中的中心重定向</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 lingyun 的个人博客">lingyun</a></p>
  <p><span>发布时间:</span>2023年05月08日 - 23:05</p>
  <p><span>最后更新:</span>2023年05月14日 - 19:05</p>
  <p><span>原始链接:</span><a href="/2023/05/08/聊聊iOS中的中心重定向/" title="聊聊iOS中的中心重定向">https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
  });
    });  
</script>


      <div>
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="lingyun 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="lingyun 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        
<div class="my_post_copyright">
  <script src="//s0.pstatp.com/cdn/expire-1-M/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://s1.pstatp.com/cdn/expire-1-M/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2023/05/08/聊聊iOS中的中心重定向/">聊聊iOS中的中心重定向</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 lingyun 的个人博客">lingyun</a></p>
  <p><span>发布时间:</span>2023年05月08日 - 23:05</p>
  <p><span>最后更新:</span>2023年05月14日 - 19:05</p>
  <p><span>原始链接:</span><a href="/2023/05/08/聊聊iOS中的中心重定向/" title="聊聊iOS中的中心重定向">https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://tsuijunxi.github.io/2023/05/08/聊聊iOS中的中心重定向/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
  });
    });  
</script>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Trampoline-中心重定向-InlineHook/" rel="tag"># Trampoline 中心重定向 InlineHook</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/11/23/优先级反转那些事儿/" rel="next" title="优先级反转那些事儿">
                <i class="fa fa-chevron-left"></i> 优先级反转那些事儿
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/favicon.ico"
                alt="lingyun" />
            
              <p class="site-author-name" itemprop="name">lingyun</p>
              <p class="site-description motion-element" itemprop="description">Stay Hungry, Stay Foolish</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#如何用-JS-语法书写-iOS？"><span class="nav-number">2.</span> <span class="nav-text">如何用 JS 语法书写 iOS？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#暴力映射"><span class="nav-number">2.1.</span> <span class="nav-text">暴力映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#c-重定向"><span class="nav-number">2.2.</span> <span class="nav-text">__c 重定向</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#登录判定中心重定向"><span class="nav-number">3.</span> <span class="nav-text">登录判定中心重定向</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义一次性观察者"><span class="nav-number">3.1.</span> <span class="nav-text">定义一次性观察者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#登录回调"><span class="nav-number">3.2.</span> <span class="nav-text">登录回调</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义登录代理"><span class="nav-number">3.3.</span> <span class="nav-text">定义登录代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义-NSObject-分类-LoginProxy"><span class="nav-number">3.4.</span> <span class="nav-text">定义 NSObject 分类 LoginProxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调用流程"><span class="nav-number">3.5.</span> <span class="nav-text">调用流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#如何中心重定向任意一个Block？"><span class="nav-number">4.</span> <span class="nav-text">如何中心重定向任意一个Block？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#目前效果"><span class="nav-number">4.1.</span> <span class="nav-text">目前效果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vm-remap-技术"><span class="nav-number">4.2.</span> <span class="nav-text">vm_remap 技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#原理"><span class="nav-number">4.2.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码实践"><span class="nav-number">4.2.2.</span> <span class="nav-text">代码实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Block-的结构表达"><span class="nav-number">4.3.</span> <span class="nav-text">Block 的结构表达</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#流程跳转逻辑"><span class="nav-number">4.4.</span> <span class="nav-text">流程跳转逻辑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#arm64-汇编实现"><span class="nav-number">4.5.</span> <span class="nav-text">arm64 汇编实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#寄存器"><span class="nav-number">4.5.1.</span> <span class="nav-text">寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#汇编代码"><span class="nav-number">4.5.2.</span> <span class="nav-text">汇编代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hopper示意图"><span class="nav-number">4.5.3.</span> <span class="nav-text">Hopper示意图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x86-64-汇编实现"><span class="nav-number">4.6.</span> <span class="nav-text">x86_64 汇编实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#寄存器-1"><span class="nav-number">4.6.1.</span> <span class="nav-text">寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#汇编代码-1"><span class="nav-number">4.6.2.</span> <span class="nav-text">汇编代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hopper示意图-1"><span class="nav-number">4.6.3.</span> <span class="nav-text">Hopper示意图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#栈的对齐问题（坑点）"><span class="nav-number">4.6.4.</span> <span class="nav-text">栈的对齐问题（坑点）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么没有保存和恢复xmm0-xmm7"><span class="nav-number">4.6.5.</span> <span class="nav-text">为什么没有保存和恢复xmm0~xmm7?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#思考"><span class="nav-number">4.7.</span> <span class="nav-text">思考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考链接"><span class="nav-number">6.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lingyun</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">133.0k</span>

  <div class="powered-by">
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_pv">
      本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>|
    <i class="fa fa-eye-md"></i>
    <span id="busuanzi_container_site_uv">
      本站访客数:<span id="busuanzi_value_site_uv"></span>人
    </span>

  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="/js/src/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '3b98a5ec68bfccc21c29',
          clientSecret: '4c30086ddf0fdf77d050830b540bcffd3054c1b0',
          repo: 'tsuijunxi.github.io',
          owner: 'tsuijunxi',
          admin: ['tsuijunxi'], 
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>


  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
