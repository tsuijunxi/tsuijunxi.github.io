<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "a56087b5"
    });
  daovoice('update');
  </script>




  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS," />










<meta name="description" content="前言JavaScriptCore引擎的分析由于其复杂性，耗时性，暂时先告一段落，后续会进行回归，本篇将总结一些日常开发中遇到的问题 问题列表启动图之前在做视频闪屏的时候，遇到了一个比较棘手的问题：每次加载本地视频都会有一段黑屏的时间（大概0.2s左右），这本身和AVPlayer有很大的关系，猜测和视频的解码有关，无奈由于闭源，无计可施。123456789101112131415- (void)se">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS问题集锦">
<meta property="og:url" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/index.html">
<meta property="og:site_name" content="凌云的博客">
<meta property="og:description" content="前言JavaScriptCore引擎的分析由于其复杂性，耗时性，暂时先告一段落，后续会进行回归，本篇将总结一些日常开发中遇到的问题 问题列表启动图之前在做视频闪屏的时候，遇到了一个比较棘手的问题：每次加载本地视频都会有一段黑屏的时间（大概0.2s左右），这本身和AVPlayer有很大的关系，猜测和视频的解码有关，无奈由于闭源，无计可施。123456789101112131415- (void)se">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/01.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/02.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/04.gif">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/03.gif">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/05.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/06.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/07.png">
<meta property="og:updated_time" content="2018-12-31T10:52:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS问题集锦">
<meta name="twitter:description" content="前言JavaScriptCore引擎的分析由于其复杂性，耗时性，暂时先告一段落，后续会进行回归，本篇将总结一些日常开发中遇到的问题 问题列表启动图之前在做视频闪屏的时候，遇到了一个比较棘手的问题：每次加载本地视频都会有一段黑屏的时间（大概0.2s左右），这本身和AVPlayer有很大的关系，猜测和视频的解码有关，无奈由于闭源，无计可施。123456789101112131415- (void)se">
<meta name="twitter:image" content="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/"/>





  <title>iOS问题集锦 | 凌云的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">凌云的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lingyun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.ico">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凌云的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS问题集锦</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-13T22:45:33+08:00">
                2018-11-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,957
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  33
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>JavaScriptCore引擎的分析由于其复杂性，耗时性，暂时先告一段落，后续会进行回归，本篇将总结一些日常开发中遇到的问题</p>
<h2 id="问题列表"><a href="#问题列表" class="headerlink" title="问题列表"></a>问题列表</h2><h3 id="启动图"><a href="#启动图" class="headerlink" title="启动图"></a>启动图</h3><p>之前在做视频闪屏的时候，遇到了一个比较棘手的问题：每次加载本地视频都会有一段黑屏的时间（大概0.2s左右），这本身和<code>AVPlayer</code>有很大的关系，猜测和视频的解码有关，无奈由于闭源，无计可施。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupVideoPlayer</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSURL</span>* fileUrl = [<span class="built_in">NSURL</span> fileURLWithPath:<span class="string">@"本地视频url"</span>];</span><br><span class="line">    <span class="built_in">AVAsset</span> *movieAsset = [<span class="built_in">AVURLAsset</span> URLAssetWithURL:fileUrl options:<span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">AVPlayerItem</span> * playerItem = [<span class="built_in">AVPlayerItem</span> playerItemWithAsset:movieAsset];</span><br><span class="line">    <span class="keyword">self</span>.player = [<span class="built_in">AVPlayer</span>  playerWithPlayerItem:playerItem];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.moviePlayer = [[<span class="built_in">AVPlayerViewController</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.moviePlayer.showsPlaybackControls = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">self</span>.moviePlayer.player = <span class="keyword">self</span>.player;</span><br><span class="line">    <span class="keyword">self</span>.moviePlayer.view.backgroundColor = <span class="keyword">self</span>.view.backgroundColor;</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.moviePlayer.view];</span><br><span class="line">    <span class="keyword">self</span>.moviePlayer.view.frame = <span class="keyword">self</span>.view.frame;</span><br><span class="line">    <span class="keyword">self</span>.moviePlayer.videoGravity = <span class="built_in">AVLayerVideoGravityResizeAspectFill</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>后来有童鞋想了个办法：因为闪屏是在启动图之后，所以人为地在这段黑屏的时间里，在闪屏的VC上面盖一个<code>UIImageView</code>，其image就是启动图，等过了这段黑屏时间，再把这个<code>UIImageView</code>移除，一个不错的解决方案，尽管这里的黑屏时间还是无法得到精确的控制！</p>
<p>然而又碰到了问题：<br>日常开发天天见的启动图，这个时候竟然找不到！！！在mainBundle里面找不到任何启动图资源！！！<br>难道要将所有的启动图像添加资源又往项目中添加了一遍吗？？？<br>我的感觉是：好残忍！每一张启动图都很大！并且有2x和3x之分，关键是还有很多尺寸…</p>
<p>经过调研，发现还是有办法拿到启动图的，只是这个时候不再是url，而是直接从内存中获取<code>UIImage</code>:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSString</span> *)getLaunchImageName</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGSize</span> viewSize = [<span class="built_in">UIApplication</span> sharedApplication].delegate.window.bounds.size;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *viewOrientation =  <span class="string">@"Portrait"</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">UIInterfaceOrientationIsLandscape</span>([<span class="built_in">UIApplication</span> sharedApplication].statusBarOrientation))&#123;</span><br><span class="line">        viewOrientation = <span class="string">@"Landscape"</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *launchImageName = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSArray</span>* imagesDict = [[[<span class="built_in">NSBundle</span> mainBundle] infoDictionary] valueForKey:<span class="string">@"UILaunchImages"</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSDictionary</span>* dict <span class="keyword">in</span> imagesDict)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CGSize</span> imageSize = <span class="built_in">CGSizeFromString</span>(dict[<span class="string">@"UILaunchImageSize"</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">CGSizeEqualToSize</span>(imageSize, viewSize) &amp;&amp; [viewOrientation isEqualToString:dict[<span class="string">@"UILaunchImageOrientation"</span>]])</span><br><span class="line">        &#123;</span><br><span class="line">            launchImageName = dict[<span class="string">@"UILaunchImageName"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> launchImageName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="你真的在复用cell吗？"><a href="#你真的在复用cell吗？" class="headerlink" title="你真的在复用cell吗？"></a>你真的在复用cell吗？</h3><p>iOS开发中，cell复用是一件再正常不过的事情了，然而有许多比较复杂的cell，里面的元素个数不确定，每次拿到复用的cell都要进行各种逻辑判断，得到一个合适的cell高度，并进行cell内部的重新布局，这使得cell的复用大打折扣。有的童鞋为了避免这种麻烦，干脆在拿到cell之后，首先把内部的子视图全部移除，然后重新按照模型数据生成新的子视图，这样固然是省事多了，但是随之也带来了性能问题。<br>以QQ阅读的漫画书城为例：<br>在每次给cell设置数据的时候是这样的：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setViewModel:(<span class="keyword">id</span>&lt;XXXViewModelDelegate&gt;)viewModel</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 每次拿到cell的时候都会把cell上的子视图全部清理掉</span></span><br><span class="line">    [<span class="keyword">self</span>.subviews enumerateObjectsUsingBlock:^(XXXSubView * _Nonnull obj,</span><br><span class="line">                                                        <span class="built_in">NSUInteger</span> idx,</span><br><span class="line">                                                        <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        [obj removeFromSuperview];</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 然后重新初始化子视图，并设置数据</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过intrument测量发现，<code>cellForRow</code>的时间占比高达17.6%<br><img src="/2018/11/13/iOS问题集锦/01.png" alt="优化前"></p>
<p>秉着以下原则，对漫画书城的cell的逻辑进行了修改：</p>
<blockquote>
<ul>
<li>复用cell，且cell中的每个子视图创建且仅应该创建1次；</li>
<li>每个子视图采用懒加载的方式进行创建，即只在需要的时候进行加载；</li>
<li>当复用的cell的子视图对于当前的数据”过剩”时，采取隐藏的方式；</li>
<li>每次网络请求到的数据，每个数据模型的高度计算且只应该计算1次，计算之后缓存下来复用；当重新刷新后，模型数据及其高度应该全部抛弃；</li>
</ul>
</blockquote>
<p>之后通过intrument测量发现，发现<code>cellForRow</code>的时间占比已经下降到7.5%<br><img src="/2018/11/13/iOS问题集锦/02.png" alt="优化后"></p>
<p>所以不要小觑创建视图带来的性能消耗！</p>
<h3 id="会说谎的屏幕尺寸"><a href="#会说谎的屏幕尺寸" class="headerlink" title="会说谎的屏幕尺寸"></a>会说谎的屏幕尺寸</h3><p>之前项目中是这样判定iPhoneX设备的<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define IS_IPHONEX                      ([UIScreen instancesRespondToSelector:@selector(currentMode)] ? CGSizeEqualToSize(CGSizeMake(1125, 2436), [[UIScreen mainScreen] currentMode].size) : NO)</span></span><br></pre></td></tr></table></figure></p>
<p>这段代码看上去倒是没有什么问题，适配以来在iPhoneX上也并未出过什么问题，然而直到今年苹果爸爸又推出了新的3款iPhone设备，iPhoneXS、iPhoneXR、iPhoneXSMax，问题来了：</p>
<p>这3款新的设备都是刘海屏，刘海高度都是一致的，这样其UI适配和iPhoneX的适配无二异，所以按照搬砖惯性，不自觉地就会往这个宏里面加点东西：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define IS_IPHONEX                      ([UIScreen instancesRespondToSelector:@selector(currentMode)] ?\</span></span><br><span class="line">    (<span class="built_in">CGSizeEqualToSize</span>(<span class="built_in">CGSizeMake</span>(<span class="number">1125</span>, <span class="number">2436</span>),  [[<span class="built_in">UIScreen</span> mainScreen] currentMode].size) ||\</span><br><span class="line">     <span class="built_in">CGSizeEqualToSize</span>(<span class="built_in">CGSizeMake</span>(<span class="number">1242</span>, <span class="number">2688</span>),  [[<span class="built_in">UIScreen</span> mainScreen] currentMode].size) ||\</span><br><span class="line">     <span class="built_in">CGSizeEqualToSize</span>(<span class="built_in">CGSizeMake</span>(<span class="number">828</span>, <span class="number">1792</span>) ,  [[<span class="built_in">UIScreen</span> mainScreen] currentMode].size)  )\</span><br><span class="line">     : <span class="literal">NO</span>)</span><br></pre></td></tr></table></figure></p>
<p>自然这个时候IS_IPHONEX不仅仅代表iPhoneX设备，而是一系列刘海屏设备。</p>
<p>然而在一款新的设备iPhoneXR上，该宏总是返回NO，上了断点，才发现该机器返回的屏幕尺寸<br>(width = 750, height = 1624)<br>瞬间有一种颠覆人生观的感觉。难道买了个假的iPhoneXR ？<br>纠结了半天，才有同学想起来是 <strong>放大模式</strong> 的问题，去设置里面看了下，果然是！</p>
<p>问题找到了，所以分别针对iPhoneXR和iPhoneXSMax，继续加了两个尺寸（经过确认和其它的机型不会重复）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(width = 750, height = 1624) iphonexr 放大模式</span><br><span class="line">(width = 1125, height = 2436) iphonexmax 放大模式（和iphonex的正常模式大小一致）</span><br></pre></td></tr></table></figure></p>
<p>然而，这样的解决方式有很大的缺陷：</p>
<blockquote>
<ul>
<li>代码很臃肿，判定很繁琐，并且可能考虑的不够周到，目前支持放大模式的设备还不少：iphone6/6s、iphone7/7s、iphone8/8s、iphonexr、iphonexmax都有放大模式；</li>
<li>如果留海设备A的放大尺寸正好是非留海设备B的正常尺寸，会导致宏判定失效，即使当前没有，如果以后出了一款正常屏幕的设备，但是尺寸却和某款刘海屏的放大模式一致，也会导致判定失效</li>
</ul>
</blockquote>
<p>有同学给出了这样的解决方案：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define IS_IPHONEX \</span></span><br><span class="line">(&#123;<span class="built_in">BOOL</span> isPhoneX = <span class="literal">NO</span>;\</span><br><span class="line"><span class="keyword">if</span> (@available(iOS <span class="number">11.0</span>, *)) &#123;\</span><br><span class="line">isPhoneX = [[<span class="built_in">UIApplication</span> sharedApplication] delegate].window.safeAreaInsets.bottom &gt; <span class="number">0.0</span>;\</span><br><span class="line">&#125;\</span><br><span class="line">(isPhoneX);&#125;)</span><br></pre></td></tr></table></figure></p>
<p>相对来说就比较简单了，用到了异形屏的安全区的概念，比较漂亮的解法！</p>
<p>不过也有一个缺陷：<strong>在window创建之前，这个宏是无法使用的</strong>，有的情况下，例如在load里面对<code>IS_IPHONEX</code>做判定，这个宏是无法做到的</p>
<p>实际上，屏幕会说谎，设备却不会，用下面的方法更简单准确：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)platform &#123;</span><br><span class="line">    </span><br><span class="line">    size_t size;</span><br><span class="line">    sysctlbyname(<span class="string">"hw.machine"</span>, <span class="literal">NULL</span>, &amp;size, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> *machine = malloc(size);</span><br><span class="line">    sysctlbyname(<span class="string">"hw.machine"</span>, machine, &amp;size, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *platform = [<span class="built_in">NSString</span> stringWithUTF8String:machine];</span><br><span class="line">    free(machine);</span><br><span class="line">    <span class="keyword">return</span> platform;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)isPhoneX</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span>* plat = [<span class="keyword">self</span> platform];</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> ([platform isEqualToString:<span class="string">@"iPhone10,3"</span>] || </span><br><span class="line">        [platform isEqualToString:<span class="string">@"iPhone10,6"</span>]) &#123;</span><br><span class="line">         <span class="comment">//  modelType = DeviceModelTypeIPhoneX</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>([platform isEqualToString:<span class="string">@"iPhone11,2"</span>]) &#123;</span><br><span class="line">        <span class="comment">// modelType = DeviceModelTypeIPhoneXS</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([platform isEqualToString:<span class="string">@"iPhone11,4"</span>] || </span><br><span class="line">             [platform isEqualToString:<span class="string">@"iPhone11,6"</span>])&#123;</span><br><span class="line">        <span class="comment">// modelType = DeviceModelTypeIPhoneXSMAX</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>([platform isEqualToString:<span class="string">@"iPhone11,8"</span>])&#123;</span><br><span class="line">        <span class="comment">// modelType = DeviceModelTypeIPhoneXR;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再也不用担心老年机模式了，打完收工。</p>
<h3 id="躺着的tableview"><a href="#躺着的tableview" class="headerlink" title="躺着的tableview"></a>躺着的tableview</h3><p>平常情况下，<code>UITableView</code>可以通过简单的设置实现SectionHeader悬浮问题，然而想要一个躺着的<code>UITableView</code>来实现悬浮就没那么容易了，需要借助于<code>UICollectionView</code>，悬浮要靠自己来实现。</p>
<div style="float:left;border:solid 1px 000;margin:10px;"><img src="/2018/11/13/iOS问题集锦/04.gif" width="300" height="590"></div>

<div style="float:left;border:solid 1px 000;margin:10px;"><img src="/2018/11/13/iOS问题集锦/03.gif" width="300" height="590"></div><br><div style="float:none;clear:both;"><br></div>

<p>这里主要实现了一个QRHorizontalFloatingHeaderLayout，它继承自UICollectionViewLayout，使用方式如下，之后需要把<code>QRHorizontalFloatingHeaderLayoutDelegate</code>中的代理方法实现一下就可以了：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">QRHorizontalFloatingHeaderLayout *layout = [[QRHorizontalFloatingHeaderLayout alloc] init];</span><br><span class="line">    </span><br><span class="line">_collectionView = [[<span class="built_in">UICollectionView</span> alloc]initWithFrame:frame</span><br><span class="line">                                        collectionViewLayout:layout];</span><br></pre></td></tr></table></figure></p>
<p><code>QRHorizontalFloatingHeaderLayout</code>是用OC实现的，主要参照与这里的Swift版本：<br><code>https://github.com/cruzdiego/HorizontalFloatingHeaderLayout</code>，代码的核心在于在滚动的过程中去定位<code>FloatingHeader</code>的位置坐标，具体细节请查看代码</p>
<p>实现的OC版本代码如下<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">QRHorizontalFloatingHeaderLayoutDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Item size</span></span><br><span class="line">- (<span class="built_in">CGSize</span>) collectionView:(<span class="built_in">UICollectionView</span>*)collectionView horizontalFloatingHeaderItemSizeAt:(<span class="built_in">NSIndexPath</span>*)indexPath;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Header size</span></span><br><span class="line">- (<span class="built_in">CGSize</span>) collectionView:(<span class="built_in">UICollectionView</span>*)collectionView horizontalFloatingHeaderSizeAt:(<span class="built_in">NSInteger</span>)section;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Section Inset</span></span><br><span class="line">- (<span class="built_in">CGFloat</span>) collectionView:(<span class="built_in">UICollectionView</span>*)collectionView horizontalFloatingHeaderItemSpacingForSectionAt:(<span class="built_in">NSInteger</span>)section;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Item Spacing</span></span><br><span class="line">- (<span class="built_in">CGFloat</span>) collectionView:(<span class="built_in">UICollectionView</span> *)collectionView horizontalFloatingHeaderColumnSpacingForSectionAt:(<span class="built_in">NSInteger</span>)section;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Line Spacing</span></span><br><span class="line">- (<span class="built_in">UIEdgeInsets</span>) collectionView:(<span class="built_in">UICollectionView</span>*)collectionView horizontalFloatingHeaderSectionInsetAt:(<span class="built_in">NSInteger</span>)section;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Left Margin</span></span><br><span class="line">- (<span class="built_in">CGFloat</span>) collectionView:(<span class="built_in">UICollectionView</span>*)collectionView horizontalFloatingHeaderLeftMarginForSectionAt:(<span class="built_in">NSInteger</span>)section;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QRHorizontalFloatingHeaderLayout</span> : <span class="title">UICollectionViewLayout</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"QRHorizontalFloatingHeaderLayout.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QRHorizontalFloatingHeaderLayout</span>()</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSMutableDictionary</span>* itemsAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)<span class="built_in">CGFloat</span> currentMinX;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)<span class="built_in">CGFloat</span> currentMinY;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)<span class="built_in">CGFloat</span> currentMaxX;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">QRHorizontalFloatingHeaderLayout</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">self</span> = [<span class="keyword">super</span> init])</span><br><span class="line">    &#123;</span><br><span class="line">        _itemsAttributes = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">        _currentMaxX = <span class="number">0</span>;</span><br><span class="line">        _currentMinX = <span class="number">0</span>;</span><br><span class="line">        _currentMinY = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGSize</span>)collectionViewContentSize</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">self</span>.collectionView)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CGSizeZero</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UICollectionView</span>* collectionView = <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="built_in">NSInteger</span> lastSection = collectionView.numberOfSections - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(lastSection &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CGSizeZero</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> contentWidth = <span class="keyword">self</span>.lastItemMaxX + [<span class="keyword">self</span> insetForSection:lastSection].right;</span><br><span class="line">    <span class="built_in">CGFloat</span> contentHeight =</span><br><span class="line">    collectionView.bounds.size.height -</span><br><span class="line">    collectionView.contentInset.top -</span><br><span class="line">    collectionView.contentInset.bottom;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CGSizeMake</span>(contentWidth,contentHeight);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)lastItemMaxX</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UICollectionView</span>* collectionView = <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="built_in">NSInteger</span> lastSection = collectionView.numberOfSections - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">NSInteger</span> lastRow = [collectionView numberOfItemsInSection:lastSection] <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">UICollectionViewLayoutAttributes</span>* lastItemAttributes =</span><br><span class="line">    [<span class="keyword">self</span> layoutAttributesForItemAtIndexPath:[<span class="built_in">NSIndexPath</span></span><br><span class="line">                                              indexPathForRow:lastRow inSection:lastSection]];</span><br><span class="line">    <span class="keyword">return</span> lastItemAttributes ? <span class="built_in">CGRectGetMaxX</span>(lastItemAttributes.frame) : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UICollectionViewLayoutAttributes</span>*)layoutAttributesForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSIndexPath</span>* aIndexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:indexPath.row inSection:indexPath.section];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.itemsAttributes[aIndexPath];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UICollectionViewLayoutAttributes</span>*)layoutAttributesForSupplementaryViewOfKind:(<span class="built_in">NSString</span> *)elementKind</span><br><span class="line">                                                                    atIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>([elementKind isEqualToString:<span class="built_in">UICollectionElementKindSectionHeader</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span>.sectionHeadersAttributes qr_safeObjectForKey:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)shouldInvalidateLayoutForBoundsChange:(<span class="built_in">CGRect</span>)newBounds</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UICollectionViewLayoutInvalidationContext</span>*)invalidationContextForBoundsChange:(<span class="built_in">CGRect</span>)newBounds</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UICollectionViewLayoutInvalidationContext</span>* context = [<span class="keyword">super</span> invalidationContextForBoundsChange:newBounds];</span><br><span class="line">    <span class="built_in">CGRect</span> oldBounds = <span class="keyword">self</span>.collectionView.bounds;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> isSizeChanged =</span><br><span class="line">    oldBounds.size.width != newBounds.size.width ||</span><br><span class="line">    oldBounds.size.height != newBounds.size.height;</span><br><span class="line">    <span class="keyword">if</span>(!isSizeChanged)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">NSArray</span>* headersIndexPaths = [<span class="keyword">self</span>.sectionHeadersAttributes allKeys];</span><br><span class="line">        [context invalidateSupplementaryElementsOfKind:<span class="built_in">UICollectionElementKindSectionHeader</span></span><br><span class="line">                                          atIndexPaths:headersIndexPaths];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)prepareLayout</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> prepareItemsAttributes];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewLayoutAttributes</span> *&gt; *)layoutAttributesForElementsInRect:(<span class="built_in">CGRect</span>)rect</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewLayoutAttributes</span> *&gt; * itemsA =</span><br><span class="line">    [<span class="keyword">self</span> attributes:<span class="keyword">self</span>.itemsAttributes containedInRect:rect];</span><br><span class="line">    <span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewLayoutAttributes</span> *&gt; * itemsB =</span><br><span class="line">    [<span class="keyword">self</span>.sectionHeadersAttributes allValues];</span><br><span class="line">    <span class="keyword">return</span> [itemsA arrayByAddingObjectsFromArray:itemsB];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Private</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableDictionary</span>&lt;<span class="built_in">NSIndexPath</span>*,<span class="built_in">UICollectionViewLayoutAttributes</span>*&gt;*)sectionHeadersAttributes</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UICollectionView</span>* collectionView = <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="built_in">NSInteger</span> sectionCount = collectionView.numberOfSections;</span><br><span class="line">    <span class="keyword">if</span>(!collectionView || sectionCount &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableDictionary</span>&lt;<span class="built_in">NSIndexPath</span>*,<span class="built_in">UICollectionViewLayoutAttributes</span>*&gt;* attributes =</span><br><span class="line">    [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> section = <span class="number">0</span>; section &lt; sectionCount; section++) &#123;</span><br><span class="line">        <span class="built_in">NSIndexPath</span>* indexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:<span class="number">0</span> inSection:section];</span><br><span class="line">        <span class="built_in">UICollectionViewLayoutAttributes</span>* attribute = [<span class="keyword">self</span> attributeForSectionHeaderAtIndexPath:indexPath];</span><br><span class="line">        [attributes qr_safeSetObject:attribute forKey:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> attributes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UICollectionViewLayoutAttributes</span>*)attributeForSectionHeaderAtIndexPath:(<span class="built_in">NSIndexPath</span>*)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UICollectionViewLayoutAttributes</span>* attribute =</span><br><span class="line">    [<span class="built_in">UICollectionViewLayoutAttributes</span> layoutAttributesForSupplementaryViewOfKind:<span class="built_in">UICollectionElementKindSectionHeader</span></span><br><span class="line">                                                                   withIndexPath:indexPath];</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">UICollectionView</span>* collectionView = <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="built_in">CGSize</span> mySize = [<span class="keyword">self</span> headerSizeforSection:indexPath.section];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSInteger</span> itemsCount = [collectionView numberOfItemsInSection:indexPath.section];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UICollectionViewLayoutAttributes</span>* firstItemAttribute = [<span class="keyword">self</span> layoutAttributesForItemAtIndexPath:indexPath];</span><br><span class="line">    <span class="built_in">UICollectionViewLayoutAttributes</span>* lastItemAttribute = [<span class="keyword">self</span> layoutAttributesForItemAtIndexPath:[<span class="built_in">NSIndexPath</span> indexPathForRow:itemsCount<span class="number">-1</span> inSection:indexPath.section]];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGPoint</span> myPosition;</span><br><span class="line">    <span class="built_in">CGFloat</span> leftMargin = [<span class="keyword">self</span> leftMarginForSection:indexPath.section];</span><br><span class="line">    <span class="keyword">if</span>(itemsCount &gt; <span class="number">0</span> &amp;&amp; firstItemAttribute &amp;&amp; lastItemAttribute)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CGFloat</span> edgeX = collectionView.contentOffset.x + collectionView.contentInset.left;</span><br><span class="line">        <span class="built_in">CGFloat</span> xByLeftBoundary = MAX(edgeX+leftMargin, <span class="built_in">CGRectGetMinX</span>(firstItemAttribute.frame));</span><br><span class="line">        <span class="built_in">CGFloat</span> xByRightBoundary = <span class="built_in">CGRectGetMaxX</span>(lastItemAttribute.frame) - mySize.width;</span><br><span class="line">        <span class="built_in">CGFloat</span> x = MIN(xByLeftBoundary, xByRightBoundary);</span><br><span class="line">        myPosition = <span class="built_in">CGPointMake</span>(x, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CGFloat</span> x = [<span class="keyword">self</span> insetForSection:indexPath.section].left;</span><br><span class="line">        myPosition = <span class="built_in">CGPointMake</span>(x, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CGRect</span> frame = <span class="built_in">CGRectMake</span>(myPosition.x, myPosition.y, mySize.width, mySize.height);</span><br><span class="line">    attribute.frame = frame;</span><br><span class="line">    <span class="keyword">return</span> attribute;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewLayoutAttributes</span>*&gt;*)attributes:(<span class="built_in">NSDictionary</span>*)attributes</span><br><span class="line">                                          containedInRect:(<span class="built_in">CGRect</span>)rect</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">UICollectionViewLayoutAttributes</span>*&gt;* finalAttributes =</span><br><span class="line">    [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">UICollectionViewLayoutAttributes</span>* attribute <span class="keyword">in</span> attributes.allValues) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">CGRectIntersectsRect</span>(rect, attribute.frame))</span><br><span class="line">        &#123;</span><br><span class="line">            [finalAttributes qr_safeAddObject:attribute];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> finalAttributes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)prepareItemsAttributes</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UICollectionView</span>* collectionView =  <span class="keyword">self</span>.collectionView;</span><br><span class="line">    <span class="built_in">NSInteger</span> sectionCount = collectionView.numberOfSections;</span><br><span class="line">    <span class="keyword">if</span>(!collectionView || sectionCount &lt;= <span class="number">0</span>)&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> resetAttributes];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> section = <span class="number">0</span>; section &lt; sectionCount; section++) &#123;</span><br><span class="line">        [<span class="keyword">self</span> configureVariablesforSection:section];</span><br><span class="line">        <span class="built_in">NSInteger</span> itemCount = [collectionView numberOfItemsInSection:section];</span><br><span class="line">        <span class="keyword">if</span>(itemCount &lt;= <span class="number">0</span>)&#123; <span class="keyword">continue</span>;&#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSInteger</span> row = <span class="number">0</span>; row &lt; itemCount; row++) &#123;</span><br><span class="line">            <span class="built_in">NSIndexPath</span>* indexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:row inSection:section];</span><br><span class="line">            <span class="built_in">UICollectionViewLayoutAttributes</span>* attribute = [<span class="keyword">self</span> itemAttributeAtIndexPath:indexPath];</span><br><span class="line">            [<span class="keyword">self</span>.itemsAttributes qr_safeSetObject:attribute forKey:indexPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)resetAttributes</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.itemsAttributes removeAllObjects];</span><br><span class="line">    <span class="keyword">self</span>.currentMinX = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">self</span>.currentMaxX = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">self</span>.currentMinY = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)configureVariablesforSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIEdgeInsets</span> sectionInset = [<span class="keyword">self</span> insetForSection:section];</span><br><span class="line">    <span class="built_in">UIEdgeInsets</span> lastSectionInset = [<span class="keyword">self</span> insetForSection:section<span class="number">-1</span>];</span><br><span class="line">    <span class="keyword">self</span>.currentMinX = (<span class="keyword">self</span>.currentMaxX + sectionInset.left + lastSectionInset.right);</span><br><span class="line">    <span class="keyword">self</span>.currentMinY = sectionInset.top + [<span class="keyword">self</span> headerSizeforSection:section].height;</span><br><span class="line">    <span class="keyword">self</span>.currentMaxX = <span class="keyword">self</span>.currentMinX;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UICollectionViewLayoutAttributes</span>*)itemAttributeAtIndexPath:(<span class="built_in">NSIndexPath</span>*)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGSize</span> size = [<span class="keyword">self</span> itemSizeForIndexPath:indexPath];</span><br><span class="line">    <span class="built_in">CGFloat</span> newMaxY = <span class="keyword">self</span>.currentMinY + size.height;</span><br><span class="line">    <span class="built_in">CGPoint</span> origin = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    <span class="keyword">if</span>(newMaxY &gt;= [<span class="keyword">self</span> availableHeightAtSection:indexPath.section])</span><br><span class="line">    &#123;</span><br><span class="line">        origin.x = <span class="keyword">self</span>.currentMaxX + [<span class="keyword">self</span> columnSpacingForSection:indexPath.section];</span><br><span class="line">        origin.y = [<span class="keyword">self</span> insetForSection:indexPath.section].top + [<span class="keyword">self</span> headerSizeforSection:indexPath.section].height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        origin.x = <span class="keyword">self</span>.currentMinX;</span><br><span class="line">        origin.y = <span class="keyword">self</span>.currentMinY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGRect</span> frame = <span class="built_in">CGRectMake</span>(origin.x, origin.y, size.width, size.height);</span><br><span class="line">    <span class="built_in">UICollectionViewLayoutAttributes</span>* attribute =</span><br><span class="line">    [<span class="built_in">UICollectionViewLayoutAttributes</span> layoutAttributesForCellWithIndexPath:indexPath];</span><br><span class="line">    attribute.frame = frame;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// updateVariables</span></span><br><span class="line">    <span class="keyword">self</span>.currentMaxX = MAX(<span class="keyword">self</span>.currentMaxX,<span class="built_in">CGRectGetMaxX</span>(frame));</span><br><span class="line">    <span class="keyword">self</span>.currentMinX = <span class="built_in">CGRectGetMinX</span>(frame);</span><br><span class="line">    <span class="keyword">self</span>.currentMinY = <span class="built_in">CGRectGetMaxY</span>(frame) + [<span class="keyword">self</span> itemSpacingForSection:indexPath.section];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> attribute;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)availableHeightAtSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">self</span>.collectionView || section &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span>f;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">UIEdgeInsets</span> sectionInset = [<span class="keyword">self</span> insetForSection:section];</span><br><span class="line">    <span class="built_in">UIEdgeInsets</span> contentInset = <span class="keyword">self</span>.collectionView.contentInset;</span><br><span class="line">    <span class="built_in">CGFloat</span> totalInset = sectionInset.top + sectionInset.bottom + contentInset.top + contentInset.bottom;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.collectionView.bounds.size.height - totalInset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGSize</span>)headerSizeforSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(section &lt; <span class="number">0</span> || !<span class="keyword">self</span>.collectionView)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CGSizeZero</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt; delegate =</span><br><span class="line">    (<span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt;)(<span class="keyword">self</span>.collectionView.delegate);</span><br><span class="line">    <span class="keyword">if</span>([delegate respondsToSelector:<span class="keyword">@selector</span>(collectionView:horizontalFloatingHeaderSizeAt:)])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [delegate collectionView:<span class="keyword">self</span>.collectionView horizontalFloatingHeaderSizeAt:section];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CGSizeZero</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)itemSpacingForSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">self</span>.collectionView || section &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span>f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt; delegate =</span><br><span class="line">    (<span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt;)(<span class="keyword">self</span>.collectionView.delegate);</span><br><span class="line">    <span class="keyword">if</span>([delegate respondsToSelector:<span class="keyword">@selector</span>(collectionView:horizontalFloatingHeaderItemSpacingForSectionAt:)])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [delegate collectionView:<span class="keyword">self</span>.collectionView horizontalFloatingHeaderItemSpacingForSectionAt:section];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0.0</span>f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)leftMarginForSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">self</span>.collectionView || section &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span>f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt; delegate =</span><br><span class="line">    (<span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt;)(<span class="keyword">self</span>.collectionView.delegate);</span><br><span class="line">    <span class="keyword">if</span>([delegate respondsToSelector:<span class="keyword">@selector</span>(collectionView:horizontalFloatingHeaderLeftMarginForSectionAt:)])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [delegate collectionView:<span class="keyword">self</span>.collectionView horizontalFloatingHeaderLeftMarginForSectionAt:section];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0.0</span>f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)columnSpacingForSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">self</span>.collectionView || section &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span>f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt; delegate =</span><br><span class="line">    (<span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt;)(<span class="keyword">self</span>.collectionView.delegate);</span><br><span class="line">    <span class="keyword">if</span>([delegate respondsToSelector:<span class="keyword">@selector</span>(collectionView:horizontalFloatingHeaderColumnSpacingForSectionAt:)])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [delegate collectionView:<span class="keyword">self</span>.collectionView horizontalFloatingHeaderColumnSpacingForSectionAt:section];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0.0</span>f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGSize</span>)itemSizeForIndexPath:(<span class="built_in">NSIndexPath</span>*)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">self</span>.collectionView)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CGSizeZero</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt; delegate =</span><br><span class="line">    (<span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt;)(<span class="keyword">self</span>.collectionView.delegate);</span><br><span class="line">    <span class="keyword">if</span>([delegate respondsToSelector:<span class="keyword">@selector</span>(collectionView:horizontalFloatingHeaderItemSizeAt:)])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [delegate collectionView:<span class="keyword">self</span>.collectionView horizontalFloatingHeaderItemSizeAt:indexPath];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CGSizeZero</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIEdgeInsets</span>)insetForSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(section &lt; <span class="number">0</span> || !<span class="keyword">self</span>.collectionView)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIEdgeInsetsZero</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt; delegate =</span><br><span class="line">    (<span class="keyword">id</span>&lt;QRHorizontalFloatingHeaderLayoutDelegate&gt;)(<span class="keyword">self</span>.collectionView.delegate);</span><br><span class="line">    <span class="keyword">if</span>([delegate respondsToSelector:<span class="keyword">@selector</span>(collectionView:horizontalFloatingHeaderSectionInsetAt:)])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [delegate collectionView:<span class="keyword">self</span>.collectionView horizontalFloatingHeaderSectionInsetAt:section];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIEdgeInsetsZero</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="C-的容器如何存放OC对象"><a href="#C-的容器如何存放OC对象" class="headerlink" title="C++的容器如何存放OC对象"></a>C++的容器如何存放OC对象</h3><p>日常的iOS开发中最常用的容器莫过于<code>NSArray</code>和<code>NSDictionary</code>了，然而在一些对性能要求比较场合下这两个容器明显不给力，很多人选择objective-c++这种混编模式来开发，从而使用强大的C++ STL等类库。但是objc的对象内存管理相对而言比c++对象麻烦很多，比如将objc的对象直接保存在STL容器中时，默认的并不会对该对象进行任何管理，我们需要手动的retain和release</p>
<p>这里直接引用<a href="https://blog.csdn.net/duboleon/article/details/6272243" target="_blank" rel="noopener">大神duboleon在MRC下的解法</a><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ns_handle</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">enum</span></span><br><span class="line">      &#123;</span><br><span class="line">            _retain,</span><br><span class="line">            _assign,</span><br><span class="line">            _copy,</span><br><span class="line">      &#125;_mem_type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">const</span> _mem_type retain = _retain;</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">const</span> _mem_type assign = _assign;</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">const</span> _mem_type copy = _copy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">      ns_handle(id nsObj,_mem_type mem_type = retain);</span><br><span class="line">      ns_handle(<span class="keyword">const</span> ns_handle &amp; handle);</span><br><span class="line">      ns_handle &amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> ns_handle &amp; handle);</span><br><span class="line">      id &amp; <span class="keyword">operator</span>*();</span><br><span class="line">      ~ns_handle();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">      id m_nsObj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> ns_handle::ns_handle(id nsObj,_mem_type mem_type):m_nsObj(nsObj)</span><br><span class="line">&#123;</span><br><span class="line">      <span class="keyword">switch</span> (mem_type)</span><br><span class="line">      &#123;</span><br><span class="line">            <span class="keyword">case</span> retain:</span><br><span class="line">                  [m_nsObj retain];</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> assign:</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> copy:</span><br><span class="line">                  [m_nsObj copy];</span><br><span class="line">                  <span class="keyword">break</span>;            </span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">      &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> ns_handle::ns_handle(<span class="keyword">const</span> ns_handle &amp; handle):m_nsObj(handle.m_nsObj)</span><br><span class="line">&#123;</span><br><span class="line">    [m_nsObj retain];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> ns_handle &amp; ns_handle::<span class="keyword">operator</span>=(<span class="keyword">const</span> ns_handle &amp; handle)</span><br><span class="line">&#123;</span><br><span class="line">    [m_nsObj release];</span><br><span class="line">    m_nsObj = handle.m_nsObj;</span><br><span class="line">    [m_nsObj retain];</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> id &amp; ns_handle::<span class="keyword">operator</span>*()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> m_nsObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> ns_handle::~ns_handle()</span><br><span class="line">&#123;</span><br><span class="line">    [m_nsObj release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li>对于retain方式，即构建handle的时候原objc对象引用加一，析构的时候引用减一。</li>
<li>对于copy方式，首先该objc对象必须继承NSCopying协议并实现CopyWithZone的方法，才可以正常使用。</li>
<li>对于assign方式，则默认仅做赋值处理。</li>
<li>通过重载<em>解运算符，在调用handle的时候可以直接用</em>handle来获取句柄中保存的objc对象。</li>
</ul>
</blockquote>
<p>使用如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSString * s = @<span class="string">"Test"</span>;</span><br><span class="line"><span class="function">ns_handle <span class="title">handle</span><span class="params">(s,ns_handle::copy)</span></span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;ns_handle&gt; vec;</span><br><span class="line">vec.push_back(handle);</span><br><span class="line">NSLog(@<span class="string">"%@"</span>,*handle);</span><br></pre></td></tr></table></figure></p>
<p>那么问题来了，如果是在ARC下，又该如何来解决呢？问题的关键在于解决在ARC如何搞定retain和release，这是个棘手的问题</p>
<blockquote>
<ul>
<li>ARC如何retain和release呢？<br>首先想到了objc_retain和objc_release，然而runtime并没有暴露这两个方法的接口，所以否决了，接下来考虑到的就是修饰符：<code>__bridge_retained</code>和<code>__bridge_transfer</code>，以及<code>__bridge</code></li>
</ul>
</blockquote>
<p>ARC下，retain一个对象obj:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *retainedThing = (__bridge_retained <span class="keyword">void</span> *)obj; </span><br><span class="line">retainedThing = retainedThing;</span><br></pre></td></tr></table></figure></p>
<p>ARC下，release一个对象obj:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *retainedThing = (__bridge <span class="keyword">void</span> *)obj; </span><br><span class="line">id unretainedThing = (__bridge_transfer id)retainedThing; </span><br><span class="line">unretainedThing = nil;</span><br></pre></td></tr></table></figure></p>
<p>这里直接利用宏的形式统一处理ARC和MRC下的情况<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __has_feature(objc_arc)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UniversalRetain(...) void *retainedThing = (__bridge_retained void *)__VA_ARGS__; retainedThing = retainedThing</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UniversalRelease(...) void *retainedThing = (__bridge void *) __VA_ARGS__; id unretainedThing = (__bridge_transfer id)retainedThing; unretainedThing = nil</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UniversalRetain(...) [__VA_ARGS__ retain];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UniversalRelease(...) [__VA_ARGS__ release];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li>ARC下不能很好地处理C++里面的引用&amp;，所以直接将下面的方法的返回值从id&amp;修改为id</li>
</ul>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改前</span></span><br><span class="line"><span class="keyword">inline</span> id &amp; ns_handle::<span class="keyword">operator</span>*()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> m_nsObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改后</span></span><br><span class="line"><span class="keyword">inline</span> id ns_handle::<span class="keyword">operator</span>*()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> m_nsObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解决了上面的两个问题，给出修改后的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> NSHandle_h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSHandle_h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ns_handle</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">enum</span></span><br><span class="line">    &#123;</span><br><span class="line">        _retain,</span><br><span class="line">        _assign,</span><br><span class="line">        _copy,</span><br><span class="line">    &#125;_mem_type;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> _mem_type retain = _retain;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> _mem_type assign = _assign;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> _mem_type copy = _copy;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ns_handle(id nsObj,_mem_type mem_type = retain);</span><br><span class="line">    ns_handle(<span class="keyword">const</span> ns_handle &amp; handle);</span><br><span class="line">    ns_handle &amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> ns_handle &amp; handle);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">inline</span> id <span class="keyword">operator</span>*();</span><br><span class="line">    </span><br><span class="line">    ~ns_handle();</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    id m_nsObj;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">inline</span> ns_handle::ns_handle(id nsObj,_mem_type mem_type):m_nsObj(nsObj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (mem_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> retain:</span><br><span class="line">        &#123;</span><br><span class="line">            UniversalRetain(m_nsObj);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> assign:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> copy:</span><br><span class="line">            [m_nsObj copy];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">inline</span> ns_handle::ns_handle(<span class="keyword">const</span> ns_handle &amp; handle):m_nsObj(handle.m_nsObj)</span><br><span class="line">&#123;</span><br><span class="line">    UniversalRetain(m_nsObj);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">inline</span> ns_handle &amp; ns_handle::<span class="keyword">operator</span>=(<span class="keyword">const</span> ns_handle &amp; handle)</span><br><span class="line">&#123;</span><br><span class="line">#<span class="keyword">if</span> __has_feature(objc_arc)</span><br><span class="line">    m_nsObj = handle.m_nsObj;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    [m_nsObj release];</span><br><span class="line">    m_nsObj = handle.m_nsObj;</span><br><span class="line">    [m_nsObj retain];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> id ns_handle::<span class="keyword">operator</span>*()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> m_nsObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> ns_handle::~ns_handle()</span><br><span class="line">&#123;</span><br><span class="line">     UniversalRelease(m_nsObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* NSHandle_h */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="UIScrollView中的UIButton延迟高亮问题"><a href="#UIScrollView中的UIButton延迟高亮问题" class="headerlink" title="UIScrollView中的UIButton延迟高亮问题"></a>UIScrollView中的UIButton延迟高亮问题</h3><p>之前在开发的过程中，就发现<code>UIButton</code>的点击在<code>UITableViewCell</code>中会出现高亮延迟的现象，究其原因是：<br>当手指触摸到UIScrollView内容的一瞬间，会产生下面的动作：</p>
<p>1、拦截触摸事件,tracking属性变为YES<br>2、一个内置的计时器开始生效(默认时间间隔是150ms)，用来监控在极短的事件间隔内是否发生了手指移动<br>3、当检测到时间间隔内手指发生了移动，UIScrollView自己触发滚动，tracking属性变为NO，手指触摸下即使有(可以响应触摸事件的)内部控件也不会再响应触摸事件。<br>4、当检测到时间间隔内手指没有移动，tracking属性保持YES，手指触摸下如果有(可以响应触摸事件的)内部控件，则将触摸事件传递给控件进行处理。</p>
<p>可以通过<code>delaysContentTouches</code>属性来搞定该问题<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.tableView.delaysContentTouches = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> <span class="keyword">self</span>.tableView.subviews) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([obj respondsToSelector:<span class="keyword">@selector</span>(setDelaysContentTouches:)]) &#123;</span><br><span class="line">        [obj setDelaysContentTouches:<span class="literal">NO</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="惹不起的UITableViewCell"><a href="#惹不起的UITableViewCell" class="headerlink" title="惹不起的UITableViewCell"></a>惹不起的UITableViewCell</h3><p>最近在做个颜色标签，感觉用UILabel很省事，想不到在<code>UITableViewCell</code>却遇到了麻烦，究其原因是<code>UITableViewCell</code>在高亮的时候会改变子视图的背景色:<br><img src="/2018/11/13/iOS问题集锦/05.png" alt="优化前"></p>
<p>但是有时候，并不想要这样的效果。</p>
<p>通过查阅资料，找到一种<a href="https://m.sohu.com/n/473246903/" target="_blank" rel="noopener">解决方案</a></p>
<p>主要思想：通过swizzle方式，分别hook <code>UITableViewCell</code>的<code>setHighlighted:animated:</code>方法，和<code>UILable</code>的<code>setBackgroundColor：</code>方法。然后在<code>UITableViewCell</code>高亮的时候，修改<code>UILabel</code>的<code>forbidSetBackgroundColor</code>属性，来进行控制</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UITableViewCell+CellClick.m</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)qr_setHighlighted:(<span class="built_in">BOOL</span>)highlighted animated:(<span class="built_in">BOOL</span>)animated</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (highlighted)</span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="keyword">self</span> setupInnerLabelForbidState:<span class="literal">YES</span> superView:<span class="keyword">self</span>.contentView];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="keyword">self</span> setupInnerLabelForbidState:<span class="literal">NO</span> superView:<span class="keyword">self</span>.contentView];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> qr_setHighlighted:highlighted animated:animated];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setupInnerLabelForbidState:(<span class="built_in">BOOL</span>)forbid superView:(<span class="built_in">UIView</span>*)superView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">UIView</span> *subview <span class="keyword">in</span> superView.subviews)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ([subview isKindOfClass:[<span class="built_in">UILabel</span> <span class="keyword">class</span>]])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果设置了firbidSetBackgroundColorWhenHighlighted属性，则不允许改变</span></span><br><span class="line">            <span class="comment">// UILabel的背景色值</span></span><br><span class="line">            <span class="built_in">UILabel</span> *label = (<span class="built_in">UILabel</span> *)subview;</span><br><span class="line">            <span class="keyword">if</span>(label.firbidSetBackgroundColorWhenHighlighted)</span><br><span class="line">                label.forbidSetBackgroundColor = forbid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(subview.class.isCustomClass)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 递归遍历子视图</span></span><br><span class="line">            [<span class="keyword">self</span> setupInnerLabelForbidState:forbid superView:subview];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  UILabel+CellClick.m</span></span><br><span class="line">- (<span class="keyword">void</span>)qr_setBackgroundColor:(<span class="built_in">UIColor</span> *)backgroundColor</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果没有禁止，就可以调用原来的改变颜色方法</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.forbidSetBackgroundColor)&#123;</span><br><span class="line">        [<span class="keyword">self</span> qr_setBackgroundColor:backgroundColor];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的解决方案略显沉重，为了一个小小的背景色，竟然要付出这么高的代价，实在有些得不偿失：要知道每个<code>UITableViewCell</code>初始化的时候，都要调用<code>setBackgroundColor：</code>方法，此外还带着入侵性属性：<code>firbidSetBackgroundColorWhenHighlighted</code>，外部必须传这个属性值来告知是否要执行上面的这一套逻辑。</p>
<p>最关键的是这个方案没有彻底解决问题，虽然躲过了<code>UITableViewCell</code>的高亮逻辑，然而工程项目中有些自定义的控件（也有自己的一套高亮逻辑），却不能幸免，只能说是一个不是很完美的解决方案。</p>
<p><strong>该问题最根本的原因就是根本控制不住视图的setBackgroundColor：方法被调用</strong><br>如何化解这个大招呢？</p>
<p>如果实现一个自定义控件，设置好<code>setBackgroundColor：</code>方法的调用权限，不就好了吗？</p>
<p>以<code>QRCellLabel</code>为例：</p>
<p>1、定义一个内部类：<code>QRCellInnerLabel</code>（继承自UILabel），设置<code>shouldSetBackgroundColor</code>属性，来控制<code>setBackgroundColor:</code>的调用权限<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QRCellInnerLabel</span> : <span class="title">UILabel</span></span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="built_in">BOOL</span> shouldSetBackgroundColor;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">QRCellInnerLabel</span></span></span><br><span class="line">- (<span class="keyword">void</span>)setBackgroundColor:(<span class="built_in">UIColor</span> *)backgroundColor</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(_shouldSetBackgroundColor)</span><br><span class="line">    &#123;</span><br><span class="line">       [<span class="keyword">super</span> setBackgroundColor:backgroundColor];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>2、定义一个QRCellLabel类，和UILabel的各种属性保持一致，方便调用，编译级别禁止调用<code>setBackgroundColor:</code>方法，并暴露自己的颜色设置方法<code>qr_setBackgroundColor:</code><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QRCellLabel</span> : <span class="title">UIView</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)                 <span class="built_in">NSString</span> *text;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">null_resettable</span>, <span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)        <span class="built_in">UIFont</span> *font;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">null_resettable</span>, <span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)        <span class="built_in">UIColor</span> *textColor;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)                         <span class="built_in">NSTextAlignment</span> textAlignment;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)                         <span class="built_in">NSLineBreakMode</span> lineBreakMode;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意NS_UNAVAILABLE，编译级别禁止调用该方法</span></span><br><span class="line">- (<span class="keyword">void</span>)setBackgroundColor:(<span class="built_in">UIColor</span> *_Nullable)backgroundColor <span class="built_in">NS_UNAVAILABLE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 暴露自己的设置背景颜色方法</span></span><br><span class="line">- (<span class="keyword">void</span>)qr_setBackgroundColor:(<span class="built_in">UIColor</span> *_Nullable)backgroundColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有不够用的属性，在下面添加，然后在.m文件中重新set方法</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>3、QRCellLabel包括两个子控件：<code>UIImageView</code>和<code>QRCellInnerLabel</code>,前者是为了添加背景色，后者是为了文字。<br>分别实现<code>QRCellLabel</code>的<code>setBackgroundColor:</code>方法和<code>qr_setBackgroundColor:</code>方法：</p>
<blockquote>
<ul>
<li><code>setBackgroundColor:</code>的实现为空方法，这样即使外侧调进来，也无法改变控件的背景色；</li>
<li><code>qr_setBackgroundColor:</code>的实现如下：每次调用的时候，将<code>shouldSetBackgroundColor</code>的属性打开，一旦设置完毕<code>QRCellInnerLabel</code>的背景色，立刻将<code>shouldSetBackgroundColor</code>的属性关闭，所以该控件的背景色只能由自己暴露的<code>qr_setBackgroundColor:</code>方法来改变</li>
</ul>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">QRCellLabel</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIImageView</span>* _bgView;</span><br><span class="line">    QRCellInnerLabel* _label;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setupBackground</span><br><span class="line">&#123;</span><br><span class="line">    _bgView = [[<span class="built_in">UIImageView</span> alloc]init];</span><br><span class="line">    _bgView.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line">    [<span class="keyword">self</span> addSubview:_bgView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setBackgroundColor:(<span class="built_in">UIColor</span> *)backgroundColor</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 什么都不做，成功躲过大招</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)qr_setBackgroundColor:(<span class="built_in">UIColor</span> *)backgroundColor</span><br><span class="line">&#123;</span><br><span class="line">    [_bgView setImage:[<span class="built_in">UIImage</span> qr_imageWithColor:backgroundColor]];</span><br><span class="line"></span><br><span class="line">    _label.shouldSetBackgroundColor = <span class="literal">YES</span>;</span><br><span class="line">    _label.backgroundColor = <span class="built_in">UIColor</span>.clearColor;</span><br><span class="line">    _label.shouldSetBackgroundColor = <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 各种setter方法的重写</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setFont:(<span class="built_in">UIFont</span> *)font&#123;</span><br><span class="line">    _label.font = font;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setText:(<span class="built_in">NSString</span> *)text&#123;</span><br><span class="line">    _label.text = text;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setLineBreakMode:(<span class="built_in">NSLineBreakMode</span>)lineBreakMode&#123;</span><br><span class="line">    _label.lineBreakMode = lineBreakMode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTextAlignment:(<span class="built_in">NSTextAlignment</span>)textAlignment&#123;</span><br><span class="line">    _label.textAlignment = textAlignment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTextColor:(<span class="built_in">UIColor</span> *)textColor&#123;</span><br><span class="line">    _label.textColor = textColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这样，无论这个控件放到哪个父视图里面，也不会被修改背景色，因为没有权限！</p>
<h3 id="Lottie的坑"><a href="#Lottie的坑" class="headerlink" title="Lottie的坑"></a>Lottie的坑</h3><p>前端时间用lottie做动画的时候，碰到了几个问题，这里简单描述下：<br>（1）缓存问题<br>在利用lottie做动画的时候，都会把json文件和资源文件打包到一个bundle中，方便处理<br>有两个lottie文件如下，除了bundle的名字不一样之外，里面的json文件名和资源名称都是一样的：<br><img src="/2018/11/13/iOS问题集锦/06.png" width="60%"><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_leftAnimationBundle = [<span class="built_in">NSBundle</span> bundleWithURL:[<span class="built_in">NSBundle</span>.mainBundle URLForResource:<span class="string">@"left_animation"</span>  withExtension:<span class="string">@"bundle"</span>]];</span><br><span class="line">_leftAnimationView = [LOTAnimationView animationNamed:<span class="string">@"data"</span> inBundle:<span class="keyword">self</span>.leftAnimationBundle];</span><br><span class="line">_leftAnimationView.frame = QRRectMake(<span class="number">24</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">90</span>);</span><br><span class="line">_leftAnimationView.loopAnimation = <span class="literal">NO</span>;</span><br><span class="line">[<span class="keyword">self</span> addSubview:_leftAnimationView];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">_rightAnimationBundle = [<span class="built_in">NSBundle</span> bundleWithURL:[<span class="built_in">NSBundle</span>.mainBundle URLForResource:<span class="string">@"right_animation"</span>  withExtension:<span class="string">@"bundle"</span>]];</span><br><span class="line">_rightAnimationView = [LOTAnimationView animationNamed:<span class="string">@"data"</span> inBundle:<span class="keyword">self</span>.rightAnimationBundle];</span><br><span class="line">_rightAnimationView.frame = QRRectMake(<span class="number">100</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">90</span>);</span><br><span class="line">_rightAnimationView.loopAnimation = <span class="literal">NO</span>;</span><br><span class="line">[<span class="keyword">self</span> addSubview:_rightAnimationView];</span><br></pre></td></tr></table></figure></p>
<p>然后在加载的时候，发现第二个lottie动画总是和第一个lottie展示一样，跟踪了源码，发现了如下端倪：<strong>animationName作为key，只用到了json的文件名，所以如果第二个bundle中的json文件名如果已经出现过，就不再加载，而是直接使用缓存</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOTComposition.m</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)animationNamed:(<span class="keyword">nonnull</span> <span class="built_in">NSString</span> *)animationName inBundle:(<span class="keyword">nonnull</span> <span class="built_in">NSBundle</span> *)bundle &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的animationName作为key，只用到了json的文件名</span></span><br><span class="line">    <span class="built_in">NSArray</span> *components = [animationName componentsSeparatedByString:<span class="string">@"."</span>];</span><br><span class="line">    animationName = components.firstObject;</span><br><span class="line"></span><br><span class="line">    LOTComposition *comp = [[LOTAnimationCache sharedCache] animationForKey:animationName];</span><br><span class="line">    <span class="keyword">if</span> (comp) &#123;</span><br><span class="line">    <span class="keyword">return</span> comp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (JSONObject &amp;&amp; !error) &#123;</span><br><span class="line">        LOTComposition *laScene = [[<span class="keyword">self</span> alloc] initWithJSON:JSONObject withAssetBundle:bundle];</span><br><span class="line">        [[LOTAnimationCache sharedCache] addAnimation:laScene forKey:animationName];</span><br><span class="line">        laScene.cacheKey = animationName;</span><br><span class="line">        <span class="keyword">return</span> laScene;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这显然是不太合理的，没什么理由让开发者保证不同bundle中的json名字还要不一样。<br>如果能把bundle的文件名也能作为一个因素考虑进去，去合成一个新的key，应该就能解决问题。<br>修改如下：<strong>新建了animationKey，由json的文件名和bundle的文件名组合而成</strong><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOTComposition.m</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)animationNamed:(<span class="keyword">nonnull</span> <span class="built_in">NSString</span> *)animationName inBundle:(<span class="keyword">nonnull</span> <span class="built_in">NSBundle</span> *)bundle</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *components = [animationName componentsSeparatedByString:<span class="string">@"."</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里的key需要将bundle也作为一个参考因素，否则，多个bundle如果内部的json名字一样，会出问题</span></span><br><span class="line">    <span class="built_in">NSString</span>* animationKey = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@_%@"</span>,components.firstObject,bundle.bundlePath.lastPathComponent];</span><br><span class="line">    </span><br><span class="line">    LOTComposition *comp = [[LOTAnimationCache sharedCache] animationForKey:animationKey];</span><br><span class="line">    <span class="keyword">if</span> (comp) &#123;</span><br><span class="line">        <span class="keyword">return</span> comp;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (JSONObject &amp;&amp; !error) &#123;</span><br><span class="line">        LOTComposition *laScene = [[<span class="keyword">self</span> alloc] initWithJSON:JSONObject withAssetBundle:bundle];</span><br><span class="line">        [[LOTAnimationCache sharedCache] addAnimation:laScene forKey:animationKey];</span><br><span class="line">        laScene.cacheKey = animationKey;</span><br><span class="line">        <span class="keyword">return</span> laScene;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>（2）回调问题<br>由于项目需要，lottie动画播放完毕后，还需要做一些回调处理，所以一开始便用了下面的api<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)playWithCompletion:(<span class="keyword">nullable</span> LOTAnimationCompletionBlock)completion;</span><br></pre></td></tr></table></figure></p>
<p>但是却得不到任何回调处理，<a href="https://github.com/airbnb/lottie-ios/issues/304" target="_blank" rel="noopener">issue中也的确存在这个问题</a></p>
<p>后来直接设置回调，设置loopAnimation为NO，然后调用play，回调OK了<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_leftAnimationView.loopAnimation = <span class="literal">NO</span>;<span class="comment">// 如果设置为YES，会一直播放下去，不会回调</span></span><br><span class="line">_leftAnimationView.completionBlock = [leftCompletionBlock <span class="keyword">copy</span>];</span><br><span class="line">[_leftAnimationView play];</span><br></pre></td></tr></table></figure></p>
<p>然而问题接踵而至：<br>项目需求中需要连续播放2次动画，然后再进行回调，lottie并没有这样的api可以调用，解决办法是在回调中再次调用<code>play</code>方法<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@weakify(<span class="keyword">self</span>)</span><br><span class="line"><span class="keyword">id</span> (^leftCompletionBlock)(<span class="built_in">BOOL</span> animationFinished) = ^(<span class="built_in">BOOL</span> animationFinished)</span><br><span class="line">&#123;</span><br><span class="line">    @strongify(<span class="keyword">self</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">self</span>.leftAnimationView.tag == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.leftAnimationView.tag = <span class="number">1</span>;</span><br><span class="line">        [<span class="keyword">self</span>.leftAnimationView play];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.leftAnimationView.tag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">self</span>.leftAnimationView.hidden = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后的回调处理</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>本以为问题应该得到解决了，然而还是有点天真，第二次回调死活不回来。。。<br>跟踪源码后发现，回调只要调用1次，就会被设置为空：<code>self.completionBlock = nil</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// LOTAnimationView.m</span><br><span class="line">- (void)_callCompletionIfNecessary:(BOOL)complete &#123;</span><br><span class="line">    if (self.completionBlock) &#123;</span><br><span class="line">        LOTAnimationCompletionBlock completion = self.completionBlock;</span><br><span class="line">        self.completionBlock = nil;</span><br><span class="line">        completion(complete);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里不是特别明白作者的用意（难道是担心Block内存泄露？）<br>所以先把这里的<code>self.completionBlock = nil</code>注释掉，问题得以解决。</p>
<h3 id="UIImageView的复用问题"><a href="#UIImageView的复用问题" class="headerlink" title="UIImageView的复用问题"></a>UIImageView的复用问题</h3><p>QQReader之前有个问题：就是书架上的书封偶尔会出现错乱的情况，一直以为是cell的复用问题造成的，但是排查了许久，发现每次复用cell之前，都会把里面的UIImageView的image属性设置为nil，感觉不应该出问题，也甚至一直怀疑是刷新机制有些问题，天真的我…<br><img src="/2018/11/13/iOS问题集锦/07.png" width="50%"><br>直到最近定位到了问题所在：假设某个cell加载的一个书封urlA，在网络回来之前就被复用了，复用之后也加载了一个书封urlB，但是urlB网络回来比urlA还早（或者设置了一个本地书封），最后urlA的书封网络才回来，但是并没有解绑，所以还是会设置上去，最后本来应该显示urlB的书封，结果还是显示了urlA的书封，这样就导致了书封错乱。这也解释了每次复用之前光设置<code>UIImageView</code>的<code>image</code>属性设置为nil不够的原因。</p>
<blockquote>
<ul>
<li>那么如果工程中用的是第三方库<code>SDWebImage</code>，那么每次在复用之前需要调用这个方法来解除绑定</li>
</ul>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)sd_cancelCurrentImageLoad </span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> sd_cancelImageLoadOperationWithKey:<span class="string">@"UIImageViewImageLoad"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_cancelImageLoadOperationWithKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="comment">// Cancel in progress downloader from queue</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *operationDictionary = [<span class="keyword">self</span> operationDictionary];</span><br><span class="line">    <span class="keyword">id</span> operations = [operationDictionary objectForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (operations) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([operations isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation <span class="keyword">in</span> operations) &#123;</span><br><span class="line">                <span class="keyword">if</span> (operation) &#123;</span><br><span class="line">                    [operation cancel];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([operations conformsToProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">SDWebImageOperation</span>)])</span>&#123;</span><br><span class="line">            [(<span class="keyword">id</span>&lt;SDWebImageOperation&gt;) operations cancel];</span><br><span class="line">        &#125;</span><br><span class="line">        [operationDictionary removeObjectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果工程中是自己实现的</p>
<blockquote>
<ul>
<li>如果有解除绑定机制，那么在在复用之前解除绑定；</li>
<li>如果没有解除绑定机制，那么在网络回来之后校验一下UIImageView当前的url和回来的imagedata对应的url是否一致：</li>
</ul>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>([<span class="keyword">self</span>.imageUrl isEqualToString:imageFetchItem.key])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.image = image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>先写到这里，后续会更新添加内容</p>

      
    </div>
    
    
    

    
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束 感谢您的阅读-------------</div>
    
</div>

      <div>
    

    
      <div>
        
<div class="my_post_copyright">
  <script src="//s0.pstatp.com/cdn/expire-1-M/clipboard.js/1.5.10/clipboard.min.js"></script>
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://s1.pstatp.com/cdn/expire-1-M/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2018/11/13/iOS问题集锦/">iOS问题集锦</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 lingyun 的个人博客">lingyun</a></p>
  <p><span>发布时间:</span>2018年11月13日 - 22:11</p>
  <p><span>最后更新:</span>2018年12月31日 - 18:12</p>
  <p><span>原始链接:</span><a href="/2018/11/13/iOS问题集锦/" title="iOS问题集锦">https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
  });
    });  
</script>


      <div>
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="lingyun 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="lingyun 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        
<div class="my_post_copyright">
  <script src="//s0.pstatp.com/cdn/expire-1-M/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://s1.pstatp.com/cdn/expire-1-M/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2018/11/13/iOS问题集锦/">iOS问题集锦</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 lingyun 的个人博客">lingyun</a></p>
  <p><span>发布时间:</span>2018年11月13日 - 22:11</p>
  <p><span>最后更新:</span>2018年12月31日 - 18:12</p>
  <p><span>原始链接:</span><a href="/2018/11/13/iOS问题集锦/" title="iOS问题集锦">https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://tsuijunxi.github.io/2018/11/13/iOS问题集锦/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
  });
    });  
</script>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/20/JavaScriptCore引擎深度解析-6-LLInt解释器篇/" rel="next" title="JavaScriptCore引擎深度解析6——LLInt解释器篇">
                <i class="fa fa-chevron-left"></i> JavaScriptCore引擎深度解析6——LLInt解释器篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/13/雪花飘飘/" rel="prev" title="雪花飘飘">
                雪花飘飘 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/favicon.ico"
                alt="lingyun" />
            
              <p class="site-author-name" itemprop="name">lingyun</p>
              <p class="site-description motion-element" itemprop="description">Stay Hungry, Stay Foolish</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#问题列表"><span class="nav-number">2.</span> <span class="nav-text">问题列表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动图"><span class="nav-number">2.1.</span> <span class="nav-text">启动图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#你真的在复用cell吗？"><span class="nav-number">2.2.</span> <span class="nav-text">你真的在复用cell吗？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#会说谎的屏幕尺寸"><span class="nav-number">2.3.</span> <span class="nav-text">会说谎的屏幕尺寸</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#躺着的tableview"><span class="nav-number">2.4.</span> <span class="nav-text">躺着的tableview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-的容器如何存放OC对象"><span class="nav-number">2.5.</span> <span class="nav-text">C++的容器如何存放OC对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UIScrollView中的UIButton延迟高亮问题"><span class="nav-number">2.6.</span> <span class="nav-text">UIScrollView中的UIButton延迟高亮问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#惹不起的UITableViewCell"><span class="nav-number">2.7.</span> <span class="nav-text">惹不起的UITableViewCell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lottie的坑"><span class="nav-number">2.8.</span> <span class="nav-text">Lottie的坑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UIImageView的复用问题"><span class="nav-number">2.9.</span> <span class="nav-text">UIImageView的复用问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lingyun</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">133.0k</span>

  <div class="powered-by">
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_pv">
      本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>|
    <i class="fa fa-eye-md"></i>
    <span id="busuanzi_container_site_uv">
      本站访客数:<span id="busuanzi_value_site_uv"></span>人
    </span>

  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="/js/src/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '3b98a5ec68bfccc21c29',
          clientSecret: '4c30086ddf0fdf77d050830b540bcffd3054c1b0',
          repo: 'tsuijunxi.github.io',
          owner: 'tsuijunxi',
          admin: ['tsuijunxi'], 
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>


  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
