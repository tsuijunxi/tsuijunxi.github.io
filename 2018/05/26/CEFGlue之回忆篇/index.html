<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "a56087b5"
    });
  daovoice('update');
  </script>




  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="CEF Chromium," />










<meta name="description" content="前言刚毕业参加工作的时候，研究过一段时间CEF，解决了几个令人头疼的问题，转行之后就再没关注过。直到前两天，一个素不相识的童鞋突然不知道从哪里搞来我的QQ，加我好友询问CEF的一些问题，就在那时我突然意识到，也许这段经历应该被记录下来。———— 写给4年前的自己。 背景在.NET平台的开发中，微软自带的WebBrowser控件存在以下问题：（1）WebBrowser控件无法保证版本的一致，如果你在">
<meta name="keywords" content="CEF Chromium">
<meta property="og:type" content="article">
<meta property="og:title" content="CEFGlue之回忆篇">
<meta property="og:url" content="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/index.html">
<meta property="og:site_name" content="凌云的博客">
<meta property="og:description" content="前言刚毕业参加工作的时候，研究过一段时间CEF，解决了几个令人头疼的问题，转行之后就再没关注过。直到前两天，一个素不相识的童鞋突然不知道从哪里搞来我的QQ，加我好友询问CEF的一些问题，就在那时我突然意识到，也许这段经历应该被记录下来。———— 写给4年前的自己。 背景在.NET平台的开发中，微软自带的WebBrowser控件存在以下问题：（1）WebBrowser控件无法保证版本的一致，如果你在">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/01.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/02.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/03.png">
<meta property="og:image" content="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/04.png">
<meta property="og:updated_time" content="2018-06-03T16:04:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CEFGlue之回忆篇">
<meta name="twitter:description" content="前言刚毕业参加工作的时候，研究过一段时间CEF，解决了几个令人头疼的问题，转行之后就再没关注过。直到前两天，一个素不相识的童鞋突然不知道从哪里搞来我的QQ，加我好友询问CEF的一些问题，就在那时我突然意识到，也许这段经历应该被记录下来。———— 写给4年前的自己。 背景在.NET平台的开发中，微软自带的WebBrowser控件存在以下问题：（1）WebBrowser控件无法保证版本的一致，如果你在">
<meta name="twitter:image" content="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/"/>





  <title>CEFGlue之回忆篇 | 凌云的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">凌云的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lingyun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/favicon.ico">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凌云的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CEFGlue之回忆篇</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-26T01:08:00+08:00">
                2018-05-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C-C/" itemprop="url" rel="index">
                    <span itemprop="name">C/C++  C#</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7,551
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  35
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>刚毕业参加工作的时候，研究过一段时间CEF，解决了几个令人头疼的问题，转行之后就再没关注过。直到前两天，一个素不相识的童鞋突然不知道从哪里搞来我的QQ，加我好友询问CEF的一些问题，就在那时我突然意识到，也许这段经历应该被记录下来。———— 写给4年前的自己。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在.NET平台的开发中，微软自带的WebBrowser控件存在以下问题：<br>（1）WebBrowser控件无法保证版本的一致，如果你在Xp下，那么你就有可能调用的IE6.0的版本，同时在Window7或者更高的系统版本下WebBrowser调用的版本也可能与本机版本不一致。<br>（2）HTML页面兼容性问题，不同的浏览器对同一个页面的解释上会有页面的兼容问题。虽然电脑上安装了IE8或者更高版本的IE浏览器，但Webbrowser控件默认总是使用IE7内核兼容模式来显示网页内容，导致很多网页样式无法正常显示，例如IE7不兼容HTML5，解决方法是在注册表中为你的进程指定引用IE的版本号。<br>更多细节可以参考<a href="https://blog.csdn.net/aman1111/article/details/49705915/" target="_blank" rel="noopener">这里</a></p>
<p>为了彻底解决这些问题，经过调研，决定采用第三方开源浏览器——嵌入式Chromium框架(简称CEF) 。CEF是一个由Marshall Greenblatt在2008建立的开源项目，它主要目的是开发一个基于Google Chromium的Webbrowser控件。CEF支持一系列的编程语言和操作系统，并且能很容易地整合到新的或已有的工程中去。<br>它的设计思想政治就是易用且兼顾性能。CEF基本的框架包含C/C++程序接口，通过本地库的接口来实现，而这个库则会隔离宿主程序和Chromium&amp;Webkit的操作细节。它在浏览器控件和宿主程序之间提供紧密的整合，它支持用户插件，协议，javascript对象以及javascript扩展，宿主程序可以随意地控件资源下载，导航和打印等，并且可以跟Google Chrome浏览器一样，支持高性能和Html5技术.</p>
<p><img src="/2018/05/26/CEFGlue之回忆篇/01.png" width="65%"><br>CEFGlue的整体依赖如图所示，其中有两个棘手的问题亟待解决：</p>
<blockquote>
<ul>
<li>1、让CEF支持常规音视频的播放；</li>
<li>2、解决JS调用Native功能的问题；</li>
</ul>
</blockquote>
<h2 id="CEF支持音视频"><a href="#CEF支持音视频" class="headerlink" title="CEF支持音视频"></a>CEF支持音视频</h2><p>要想让CEF支持常规音视频的播放，需要对CEF内核重新编译</p>
<h3 id="CEF内核编译流程"><a href="#CEF内核编译流程" class="headerlink" title="CEF内核编译流程"></a>CEF内核编译流程</h3><p>说起CEF内核的编译流程都是泪，相信编译过的同学一定深有体会，在此总结一下步骤和注意事项：</p>
<blockquote>
<ul>
<li><p>1、操作系统必须是Win7旗舰版，而且必须64位，32位不支持！</p>
</li>
<li><p>2、必须设置系统语言为英文，否则会报各种编码错误！（控制面板-&gt;区域-&gt;管理-&gt;语言）</p>
</li>
<li><p>3、安装VS2013 Update 4，其他低版本不支持！</p>
</li>
<li><p>4、准备稳定可靠的VPN，用于科学上网（VPN一定要稳定！！！）</p>
</li>
<li><p>5、安装depot_tools（下载完成直接解压即可）<br> 下载地址：<a href="https://src.chromium.org/svn/trunk/tools/depot_tools.zip" target="_blank" rel="noopener">https://src.chromium.org/svn/trunk/tools/depot_tools.zip</a></p>
</li>
<li><p>6、设置depot_tools环境变量：<br>  set GYP_GENERATORS=ninja,msvs-ninja<br>  set GYP_MSVS_VERSION=2013<br>  set DEPOT_TOOLS_WIN_TOOLCHAIN=0<br>  set USE_PROPRIETARY_CODECS=1</p>
</li>
<li><p>7、下载chromium源码（CEF无法单独编译，必须依赖于chromium）</p>
<ul>
<li>设置文件夹，别出现特殊字符和中文：workspace/chromium/</li>
<li>进入文件夹， fetch –nohooks chromium（会执行很久很久），如果中间失败，     请执行gclient sync</li>
<li>确定CEF内核的版本，根据CEF内核的版本确定chrome的版本（例如 4d096306deb9e86953c81f08454dd6db07b406b5）</li>
<li>获取所需chromium版本<br>gclient sync –revision 4d096306deb9e86953c81f08454dd6db07b406b5 –jobs 16<br>注：该步骤需要非常漫长的时间，需要耐心等待</li>
</ul>
</li>
<li><p>8、将对应版本的CEF源码文件夹拷贝到chromium/src<br>  修改CEF编译选项：<br>  打开cef.gypi文件，添加以下两行代码：<br>  ‘proprietary_codecs’: 1,<br>  ‘ffmpeg_branding’:’Chrome’,<br>  如果想仔细查看各种音频视频编码支持，请查看<br>  workspace\chromium\src\third_party\ffmpeg\chromium\scripts\build_ffmpeg.py</p>
</li>
<li><p>9、编译CEF<br>  export GYP_GENERATORS=’ninja’<br>  cd workspace/chromium/src/cef<br>  cef_create_projects.bat<br>  cd workspace/chromium/src<br>  ninja -C out/Release cefclient cef_unittests</p>
</li>
<li><p>10、发布CEF内核<br>  cd workspace/chromium/src/cef/tools<br>  make_distrib.bat –ninja-build</p>
</li>
</ul>
</blockquote>
<h3 id="CEF内核的H5评估得分"><a href="#CEF内核的H5评估得分" class="headerlink" title="CEF内核的H5评估得分"></a>CEF内核的H5评估得分</h3><blockquote>
<ul>
<li>Chromium版本号      ：      43.0.2357.81</li>
<li>CEF版本号           ：      3.2357.1280.geba024d</li>
<li>具体依赖            ：      CEFGlue–&gt;CEF–&gt;Chromium</li>
</ul>
</blockquote>
<p><img src="/2018/05/26/CEFGlue之回忆篇/02.png" width="65%"></p>
<h2 id="JS调用Native功能"><a href="#JS调用Native功能" class="headerlink" title="JS调用Native功能"></a>JS调用Native功能</h2><p><code>Xilium CefGlue</code>是一款基于<code>Chromium Embedded Framework</code> (CEF)的开源WebKit内核浏览器项目，用.NET进行了各种封装，本身有很多优势，内核也在不断更新，具有良好的前景。但是，它有一个致命的问题：<code>CLR Object</code>无法很好的与网页前端<code>JavaScript</code>进行交互，实现方法非常复杂，非常繁琐。</p>
<h3 id="官方原生注册方法"><a href="#官方原生注册方法" class="headerlink" title="官方原生注册方法"></a>官方原生注册方法</h3><p>官方提供的原生方法，类对象必须继承<code>CefV8Handler</code>，所有操作方法，都必须写在该类<code>Execute ()</code>里面；类对象的所有属性、方法，都需要在后台写出对应的JS脚本，进行注册绑定；如果想执行不同操作，就需要不断的写一大堆类对象，因为每个类只能做一件事。<br>具体步骤如下：<br>(1) 定义一个<code>MyV8Handler</code>，继承自<code>CefV8Handler</code>。 <strong>注意这里注册的对象必须继承于<code>CefV8Handler</code>，这意味着注册对象收到了限制</strong><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyV8Handler</span> : <span class="title">CefV8Handler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyV8Handler</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = <span class="string">"lingyun"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span> &#123; <span class="keyword">this</span>.name = <span class="keyword">value</span>; &#125;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.name; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyFunction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MessageBox.Show(<span class="string">"JS调用C# : MyFunction"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> email;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetEmail</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.email;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetEmail</span>(<span class="params"><span class="keyword">string</span> email</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>(2) 定义一个<code>WpfRenderProcessHandler</code>，继承自<code>CefRenderProcessHandler</code>，并重写<code>OnWebKitInitialized()</code>事件，在里面写要执行的操作代码，根据类的实际情况，人工手写JS脚本代码，通过官方提供的<code>RegisterExtension</code>方法进行注册。<strong>注意这里是<code>OnWebKitInitialized</code>中完成注册，也就意味着注册时机也受到了限制，一旦WebKit初始化完成，就已经失去了注册的机会</strong><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">WpfRenderProcessHandler</span>:<span class="title">CefRenderProcessHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> MyV8Handler myHandle;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnWebKitInitialized</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        myHandle = <span class="keyword">new</span> MyV8Handler();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">string</span> jsCode = <span class="string">@"function myHandle() &#123;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        if (!myHandle) myHandle = &#123;&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        (function() &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            myHandle.__defineGetter__('name',</span></span><br><span class="line"><span class="string">            function() &#123;</span></span><br><span class="line"><span class="string">                native function GetName();</span></span><br><span class="line"><span class="string">                return GetName();</span></span><br><span class="line"><span class="string">            &#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            myHandle.__defineSetter__('name',</span></span><br><span class="line"><span class="string">            function(arg0) &#123;</span></span><br><span class="line"><span class="string">                native function SetName(arg0);</span></span><br><span class="line"><span class="string">                SetName(arg0);</span></span><br><span class="line"><span class="string">            &#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            myHandle.myFunction = function() &#123;</span></span><br><span class="line"><span class="string">                native function MyFunction();</span></span><br><span class="line"><span class="string">                return MyFunction();</span></span><br><span class="line"><span class="string">            &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            myHandle.getEmail = function() &#123;</span></span><br><span class="line"><span class="string">                native function GetEmail();</span></span><br><span class="line"><span class="string">                return GetEmail();</span></span><br><span class="line"><span class="string">            &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            myHandle.setEmail = function(arg0) &#123;</span></span><br><span class="line"><span class="string">                native function SetEmail(arg0);</span></span><br><span class="line"><span class="string">                SetEmail(arg0);</span></span><br><span class="line"><span class="string">            &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &#125;)();"</span>;</span><br><span class="line"></span><br><span class="line">        CefRuntime.RegisterExtension(<span class="string">"myHandleName"</span>, jsCode, myHandle);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">base</span>.OnWebKitInitialized();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>(3) 在<code>MyV8Handler</code>里的<code>Execute()</code>事件中，写要执行的操作代码<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">Execute</span>(<span class="params"><span class="keyword">string</span> name, CefV8Value obj, CefV8Value[] arguments, <span class="keyword">out</span> CefV8Value returnValue, <span class="keyword">out</span> <span class="keyword">string</span> exception</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">string</span> result = <span class="keyword">string</span>.Empty;</span><br><span class="line">        <span class="keyword">switch</span> (name)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"MyFunction"</span>:</span><br><span class="line">                MyFunction();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"GetEmail"</span>:</span><br><span class="line">                result = GetEmail();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"SetEmail"</span>:</span><br><span class="line">                SetEmail(arguments[<span class="number">0</span>].GetStringValue());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        returnValue = CefV8Value.CreateString(result);</span><br><span class="line">        exception = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>(4) 写一个网页，去前台通过JS调用，例如网页那边调用：<code>myHandle.myFunction ()</code>;</p>
<p>可以看到，为了注册一个Native方法，需要付出很高的代价，而且这种原生注册方法非常死板，如果想执行不同操作，就需要不断的写一大堆类对象，因为每个类只能做一件事，这样的方式没有任何通用性而言，也没有任何扩展性，写的代码近似乎于僵尸。</p>
<h3 id="高级注册方法"><a href="#高级注册方法" class="headerlink" title="高级注册方法"></a>高级注册方法</h3><h4 id="注册核心原理洞悉"><a href="#注册核心原理洞悉" class="headerlink" title="注册核心原理洞悉"></a>注册核心原理洞悉</h4><p>尽管官方的注册方式如此地繁冗，但是 <strong>核心原理</strong> 不难发现：<strong>所谓的注册本质上不过是让V8的上下文记了个方法名字和对应的参数个数和类型，告诉V8引擎，如果碰到了注册的名字，通过Excute方法把方法名和参数传出来，然后进行本地方法的匹配和调用。至于Excute方法是被谁调用的，怎么调用的，V8引擎会搞定，无需我们关心</strong>。明白了核心原理，并且.NET有良好的反射特性，我们不难推理：<strong>给定一个CLR对象，我们可以通过反射技术分析它的方法列表，并且能拿到每一个方法对应的参数个数和参数类型列表，这样就可以自动地进行注册，实现一个通用的注册方案。</strong> </p>
<h4 id="多进程通信解决方案"><a href="#多进程通信解决方案" class="headerlink" title="多进程通信解决方案"></a>多进程通信解决方案</h4><p>CEF从3.0开始，就由原先的单进程模式变为多进程模式，例如：渲染模块是由专门的渲染进程来实现的，主进程（Browser进程）与渲染进程（Render进程）通过发送消息的机制实现进程之间的通信。因为注册对象只能在V8上下文中进行注册，而V8上下文只能被Render进程访问。如果想注册某一个Native对象，一般都会把Native对象在主进程里面进行序列化，然后通过发送消息的方式发送给渲染进程，渲染进程拿到消息，首先进行反序列化得到想要注册的对象，然后再进行注册。<br><img src="/2018/05/26/CEFGlue之回忆篇/03.png" width="65%"></p>
<p>然而以上思路在实践中碰到了比较严重的问题：.NET中并非每个对象都支持序列化，尤其是我们无法去修改一个已经封装好的DLL库中的对象，所以以上方法行不通。中间也曾经考虑过共享内存的解决方案，但是发现最后都无法逃脱序列化这一步骤。</p>
<p>经过进一步深入挖掘CEF注册内部机制，发现CEF注册的时候仅仅关心的是对象的方法名和属性名，并不在意该方法的具体实现，所以可以现在Browser进程内首先将对象保存到自己的对象池中，然后将对象的方法名（属性名）通过反射技术解析出来，并发送给Render进程。Render进程接收到对象的方法名（属性名）之后，会在Render进程的上下文中实现真正的注册。一旦JS中调用本地方法，在CefV8Handler的Execute触发，就会获取到对象的方法名和参数，此时Render进程将该对象的哈希值、方法名和参数一起发送给Browser进程。Browser进程拿到这个对象的方法名和参数，会在本地注册池内进行对相匹配，一旦找到对象，会在对象的方法中寻找最适合的方法进行匹配调用，相当于方法的执行完全跑到了Browser进程中，而在整个过程中Browser进程和Render进程之间通信的内容仅仅是对象的方法名，仅仅是一个字符串，这样就避免了对象的序列化。</p>
<p><img src="/2018/05/26/CEFGlue之回忆篇/04.png" width="65%"></p>
<p>关于CEF多进程通信的问题，收集到几个对我有启发的英文片段：</p>
<blockquote>
<p>I have been struggling with this as well. I do not think there is a way to do this synchronously…or easily :) Perhaps what can be done is this:</p>
<p>From browser do sendProcessMessage with all JS information to renderer process. You can pass all kinds of parameters to this call in a structured way so encapsulating the JS method name and params in order should not be difficult to do. In renderer process (RenderProcessHandler onProcessMessageReceived method) do TryEval on the V8Context and get the return value via out parameters and sendProcessMessage back to the browser process with the JS return value (Note that this supports ordinary return semantics from your JS method).You get the browser instance reference in the onProcessMessageReceived so it is as easy as this (mixed pseudo code) browser.GetMainFrame().CefV8Context.tryEval(js-code,out retValue, out exception); process retValue; browser.sendProcessMessage(…); Browser will get a callback in the WebClient in onProcessMessageReceived. There is nothing special here in terms of setting up JS. I have for example a loaded html page with a js function in it. It takes a param as input and returns a string. in js-code parameter to TryEval I simply provide this value:</p>
<p>It is slightly convoluted but seems like a neat workable approach – better than doing ExecuteJavaScript and posting results via XHR on custom handler in my view. I tried this and it does work quite well indeed….and is not bad as it is all non-blocking. The wiring in the browser process needs to be done to process the response properly. This can be extended and built into a set of<br>classes to abstract this out for all kinds of calls.. Take a look at the Xilium demo app. Most of the necessary wiring is already there for onProcessMessage – do a global search. Look for DemoRendererProcessHandler.cs – renderer side this is where you will invoke tryEval DemoApp.cs – this is browser side, look for sendProcessMessage – this will initiate your JS invocation process. WebClient.cs – this is browser side. Here you receive messages from renderer with return value from your JS Cheers.</p>
</blockquote>
<h4 id="全自动反射注册"><a href="#全自动反射注册" class="headerlink" title="全自动反射注册"></a>全自动反射注册</h4><p>结合注册的核心原理和CEF的多进程通信方案，也通过啃一些源代码，给出最终方案的解决步骤：</p>
<p>(1) 定义一个<code>MyV8Handler</code>，但是 <strong>不再继承自<code>CefV8Handler</code></strong>，摆脱了继承这一环，这意味着程序中的任何一个对象都可以被注册，灵活度已经大大提升，至于这里为什么可以不继承自<code>CefV8Handler</code>，是因为发现了CEF的底层注册原理，后面会看到。<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyV8Handler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyV8Handler</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = <span class="string">"lingyun"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span> &#123; <span class="keyword">this</span>.name = <span class="keyword">value</span>; &#125;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.name; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyFunction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MessageBox.Show(<span class="string">"JS调用C# : MyFunction"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> email;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetEmail</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.email;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetEmail</span>(<span class="params"><span class="keyword">string</span> email</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>（2）定义一个<code>CefGlueRuntime</code>，用来启动CEF内核，同时在Browser进程注册Native对象，但是这里的注册时一个假注册，它做的事就是简单地把对象保存下来。<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CefGlueRuntime</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">object</span> locker = <span class="keyword">new</span> <span class="keyword">object</span>();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">Startup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;         </span><br><span class="line">        <span class="comment">// 装载libcef.dll</span></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            CefRuntime.Load();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            MessageBox.Show(ex.ToString(), <span class="string">"Error!"</span>, MessageBoxButton.OK, MessageBoxImage.Error);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">string</span>[] args = &#123; &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> mainArgs = <span class="keyword">new</span> CefMainArgs(args);</span><br><span class="line">        <span class="keyword">var</span> cefApp = <span class="keyword">new</span> WpfCefApp();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> exitCode = CefRuntime.ExecuteProcess(mainArgs, cefApp);</span><br><span class="line">        <span class="keyword">if</span> (exitCode != <span class="number">-1</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CEF启动参数设定</span></span><br><span class="line">        <span class="keyword">var</span> cefSettings = <span class="keyword">new</span> CefSettings</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// BrowserSubprocessPath = browserSubprocessPath,</span></span><br><span class="line">            SingleProcess = <span class="literal">true</span>,</span><br><span class="line">            WindowlessRenderingEnabled = <span class="literal">false</span>,</span><br><span class="line">            MultiThreadedMessageLoop = <span class="literal">true</span>,</span><br><span class="line">            LogSeverity = CefLogSeverity.Disable,</span><br><span class="line">            NoSandbox = <span class="literal">true</span>,                </span><br><span class="line">            UserAgent = <span class="string">"Mozilla/5.0 (Windows NT 6.2; WOW64; Trident/6.0; rv:8.0) like Gecko Chromiumembedded/43.0.2357.81 CefGlue/3.2357.1280.geba024d (cxb,Founder)"</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            CefRuntime.Initialize(mainArgs, cefSettings, cefApp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (CefRuntimeException ex)</span><br><span class="line">        &#123;</span><br><span class="line">            MessageBox.Show(ex.ToString(), <span class="string">"Error!"</span>, MessageBoxButton.OK, MessageBoxImage.Error);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Shutdown</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">lock</span> (locker)</span><br><span class="line">        &#123;</span><br><span class="line">            CefRuntime.Shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 全局对象列表，用来存放所有需要注册的对象，这里的注册并非真正的注册，只是暂时的寄存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">object</span>&gt;&gt; ObjectsList = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">object</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实际情况下，一个exportName可能对应多个obj，因为对象经过序列化和反序列化的过程，其哈希值已经发生变化，所以需要</span></span><br><span class="line">    <span class="comment">// 一开始就将对象的哈希值传递过来（不能使用反序列化之后的哈希值），然后利用该哈希值来判定一个对象是否已经注册过，这样</span></span><br><span class="line">    <span class="comment">// 就彻底解决了对象的重复注册问题</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterJsObject</span>(<span class="params"><span class="keyword">string</span> exportName, Object obj,<span class="keyword">int</span> hashCode</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 如果外部调用接口不存在，则需要创建</span></span><br><span class="line">        <span class="keyword">if</span> (!ObjectsList.ContainsKey(exportName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> objDic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>,<span class="keyword">object</span>&gt;();</span><br><span class="line">            objDic.Add(hashCode, obj);</span><br><span class="line">            ObjectsList.Add(exportName,objDic);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123; <span class="comment">// 如果外部调用接口已经存在，则直接通过判断来添加</span></span><br><span class="line">            <span class="keyword">if</span> (!ObjectsList[exportName].ContainsKey(hashCode))</span><br><span class="line">                ObjectsList[exportName].Add(hashCode, obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ObjectList.ContainsKey(hashCode))</span><br><span class="line">            ObjectList.Add(hashCode, obj);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">object</span>&gt;&gt; GetObjects()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ObjectsList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">object</span>&gt; ObjectList = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, <span class="keyword">object</span>&gt;();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>(3) 定义一个WebView，在Browser进程中，方法<code>RegisterJsObject</code>通过反射技术提取对象的方法列表，以及每个方法对应的参数个数和参数类型，并将其打包发送给Render进程，同时调用<code>CefGlueRuntime</code>的<code>RegisterJsObject</code>方法将Native对象保存下来。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WebView</span> : <span class="title">WpfCefBrowser</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行JS脚本获取返回值需要的变量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">object</span> result = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> exceptionMessage = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">public</span> AutoResetEvent signal = <span class="keyword">new</span> AutoResetEvent(<span class="literal">false</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Browser进程注册，实质上是向Render进程发送消息，由于序列化涉及到了太多的修改，甚至于无法前进，所以重新设计消息流程</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="extentionName"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="obj"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegisterJsObject</span>(<span class="params"><span class="keyword">string</span> extentionName, <span class="keyword">object</span> obj</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 协议头以register来标识</span></span><br><span class="line">        CefProcessMessage msg = CefProcessMessage.Create(<span class="string">"Register"</span>);</span><br><span class="line"></span><br><span class="line">        CefListValue objInfo = msg.Arguments;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置向JS暴露的对象名</span></span><br><span class="line">        objInfo.SetString(<span class="number">0</span>, extentionName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对象的哈希值</span></span><br><span class="line">        <span class="keyword">int</span> hashCode = obj.GetHashCode();</span><br><span class="line">        objInfo.SetInt(<span class="number">1</span>, hashCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对象的方法名</span></span><br><span class="line">        CefListValue methodList = CefListValue.Create();</span><br><span class="line">        HashSet&lt;<span class="keyword">string</span>&gt; methodNames = TypeUtil.GetMethodNames(obj.GetType());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodNames.Count; i++)</span><br><span class="line">            methodList.SetString(i, methodNames.ElementAt&lt;<span class="keyword">string</span>&gt;(i));</span><br><span class="line">        objInfo.SetList(<span class="number">2</span>, methodList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对象的属性名</span></span><br><span class="line">        CefListValue propertyList = CefListValue.Create();</span><br><span class="line">        <span class="keyword">var</span> properties = TypeUtil.GetProperties(obj.GetType());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; properties.Keys.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> propertyName = properties.Keys.ElementAt&lt;<span class="keyword">string</span>&gt;(i);</span><br><span class="line">            CefV8PropertyAttribute propertyAttribute = CefV8PropertyAttribute.None;</span><br><span class="line">            <span class="keyword">if</span> (properties[propertyName].GetSetMethod() != <span class="literal">null</span>)</span><br><span class="line">                propertyAttribute = CefV8PropertyAttribute.ReadOnly;</span><br><span class="line">            CefListValue propertyInfo = CefListValue.Create();</span><br><span class="line">            propertyInfo.SetString(<span class="number">0</span>, propertyName);</span><br><span class="line">            propertyInfo.SetInt(<span class="number">1</span>, (<span class="keyword">int</span>)propertyAttribute);</span><br><span class="line">            propertyList.SetList(i, propertyInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        objInfo.SetList(<span class="number">3</span>, propertyList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向Render进程发送消息</span></span><br><span class="line">        <span class="keyword">this</span>.SendProcessMessage(CefProcessId.Renderer, msg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将对象添加到本进程的注册池内</span></span><br><span class="line">        CefGlueRuntime.RegisterJsObject(extentionName, obj, hashCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）定义一个<code>WpfRenderProcessHandler</code>，继承自<code>CefRenderProcessHandler</code>，在<code>OnProcessMessageReceived</code>方法中接受Browser进程发送来的消息，逻辑处理在<code>ProcessRegisterMessage</code>方法中</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">OnProcessMessageReceived</span>(<span class="params">CefBrowser browser, CefProcessId sourceProcess, CefProcessMessage message</span>)</span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">// 处理注册消息</span></span><br><span class="line">    <span class="keyword">if</span> (message.Name == <span class="string">"Register"</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        ProcessRegisterMessage(message);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//执行JS获取返回值</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (message.Name == <span class="string">"EvaluteJavaScript"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (CefRuntime.CurrentlyOn(CefThreadId.Renderer))</span><br><span class="line">            ProcessEvaluateMessage(browser, message);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            Wrapper.Helpers.PostTask(CefThreadId.Renderer, Wrapper.Helpers.Apply(ProcessEvaluateMessage, browser, message));                </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (message.Name == <span class="string">"ExecuteMethodResult"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        BindingHandler.exception = message.Arguments.GetString(<span class="number">0</span>);</span><br><span class="line">        CefBinaryValue binaryValue = message.Arguments.GetBinary(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] binaryData = binaryValue.ToArray();</span><br><span class="line">        BindingHandler.result = SerializationUtil.DeserializeObject(binaryData);</span><br><span class="line">        BindingHandler.signal.Set();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有别的处理消息，则添加逻辑处理</span></span><br><span class="line">    <span class="keyword">var</span> handled = MessageRouter.OnProcessMessageReceived(browser, sourceProcess, message);</span><br><span class="line">    <span class="keyword">if</span> (handled) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 处理注册消息</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="message"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ProcessRegisterMessage</span>(<span class="params">CefProcessMessage message</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Render进程接收到Browser进程的消息，然后把接收到的参数按照约定的方式进行反序列化，相当于得到Browser发送</span></span><br><span class="line">    <span class="comment">// 对象的一份拷贝，然后添加到Render进程里的注册池中</span></span><br><span class="line">    <span class="keyword">var</span> arguments = message.Arguments;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一个参数代表extensionName</span></span><br><span class="line">    <span class="keyword">string</span> extensionName = arguments.GetString(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第二个参数代表对象的HashCode，唯一标识某一个对象</span></span><br><span class="line">    <span class="keyword">int</span> hashCode = arguments.GetInt(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第三个参数存放对象的方法列表</span></span><br><span class="line">    CefListValue methodList = arguments.GetList(<span class="number">2</span>);</span><br><span class="line">    List&lt;<span class="keyword">string</span>&gt; ml = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodList.Count; i++)</span><br><span class="line">        ml.Add(methodList.GetString(i));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第四个参数代表对象的属性列表</span></span><br><span class="line">    CefListValue propertyList = arguments.GetList(<span class="number">3</span>);</span><br><span class="line">    Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt; pl = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyList.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        CefListValue propertyInfo = propertyList.GetList(i);</span><br><span class="line">        Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; pi = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">        pi.Add(<span class="string">"propertyName"</span>, propertyInfo.GetString(<span class="number">0</span>));</span><br><span class="line">        pi.Add(<span class="string">"propertyAttribute"</span>, propertyInfo.GetInt(<span class="number">1</span>).ToString());</span><br><span class="line">        pl.Add(propertyInfo.GetString(<span class="number">0</span>),pi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CefRenderRuntime.RegisterJsObject(extensionName, hashCode, ml, pl);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义一个<code>CefRenderRuntime</code>，用来充当Render进程的对象池，接受从Browser进程传递过来的对象<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">CefRenderRuntime</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 全局对象列表，用来存放所有需要注册的对象的方法和属性，这里的注册并非真正的注册，只是暂时的寄存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">string</span>&gt;&gt;&gt; methodList = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">string</span>&gt;&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">int</span>, Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt;&gt;&gt; propertyList = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">int</span>, Dictionary&lt;<span class="keyword">string</span>, Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt;&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, HashSet&lt;<span class="keyword">int</span>&gt;&gt; keys = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, HashSet&lt;<span class="keyword">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实际情况下，一个exportName可能对应多个obj，所以用哈希值来区分多个对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterJsObject</span>(<span class="params"><span class="keyword">string</span> exportName, <span class="keyword">int</span> hashCode, List&lt;<span class="keyword">string</span>&gt; ml, Dictionary&lt;<span class="keyword">string</span>,Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt; pl</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 方法部分：如果外部调用接口不存在，则需要创建</span></span><br><span class="line">        <span class="keyword">if</span> (!methodList.ContainsKey(exportName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> methodDic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, List&lt;<span class="keyword">string</span>&gt;&gt;();</span><br><span class="line">            methodDic.Add(hashCode, ml);</span><br><span class="line">            methodList.Add(exportName, methodDic);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; <span class="comment">// 如果外部调用接口已经存在，则直接通过判断来添加</span></span><br><span class="line">            <span class="keyword">if</span> (!methodList[exportName].ContainsKey(hashCode))</span><br><span class="line">                methodList[exportName].Add(hashCode, ml);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 属性部分：如果外部调用接口不存在，则需要创建</span></span><br><span class="line">        <span class="keyword">if</span> (!propertyList.ContainsKey(exportName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyDic = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">int</span>, Dictionary&lt;<span class="keyword">string</span>,Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt;&gt;();</span><br><span class="line">            propertyDic.Add(hashCode, pl);</span><br><span class="line">            propertyList.Add(exportName, propertyDic);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; <span class="comment">// 如果外部调用接口已经存在，则直接通过判断来添加</span></span><br><span class="line">            <span class="keyword">if</span> (!propertyList[exportName].ContainsKey(hashCode))</span><br><span class="line">                propertyList[exportName].Add(hashCode, pl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Key部分</span></span><br><span class="line">         <span class="keyword">if</span> (!keys.ContainsKey(exportName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> keyDic = <span class="keyword">new</span> HashSet&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">            keyDic.Add(hashCode);</span><br><span class="line">            keys.Add(exportName, keyDic);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; <span class="comment">// 如果外部调用接口已经存在，则直接通过判断来添加               </span></span><br><span class="line">            keys[exportName].Add(hashCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;<span class="keyword">string</span>&gt; <span class="title">GetMethods</span>(<span class="params"><span class="keyword">string</span> exportName, <span class="keyword">int</span> hashcode</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> methodList[exportName][hashcode];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>,Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt; GetProperties(<span class="keyword">string</span> exportName, <span class="keyword">int</span> hashcode)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> propertyList[exportName][hashcode];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Dictionary&lt;<span class="keyword">string</span>, HashSet&lt;<span class="keyword">int</span>&gt;&gt; GetKeys()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> keys;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>（5）在<code>WpfRenderProcessHandler</code>的<code>OnContextCreated</code>方法中使用<code>BindingHandler</code>进行注册，注意这里不再是 <strong><code>OnWebKitInitialized</code>，而是<code>OnContextCreated</code>，这样意味着WebKit启动之后，我们仍然可以在每个上下文被创建的时候进行注册，注册时机也得到解放</strong><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnContextCreated</span>(<span class="params">CefBrowser browser, CefFrame frame, CefV8Context context</span>)</span></span><br><span class="line"><span class="function"></span>&#123;            </span><br><span class="line">    <span class="comment">// 当网页的上下文对象被创建的时候，则会在此重新触发Bind方法，然后在此真正的进行注册</span></span><br><span class="line">    <span class="keyword">var</span> keys = CefRenderRuntime.GetKeys();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> key <span class="keyword">in</span> keys.Keys)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> hashcodeList = keys[key];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">int</span> hashcode <span class="keyword">in</span> hashcodeList)</span><br><span class="line">        &#123;</span><br><span class="line">            BindingHandler.Bind(key, hashcode, context.GetGlobal(), browser); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    MessageRouter.OnContextCreated(browser, frame, context);</span><br><span class="line">    <span class="keyword">base</span>.OnContextCreated(browser, frame, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>BindingHandler</code>的定义如下：它继承自<code>CefV8Handler</code>，<strong>这里的Bind函数是核心重点，可以看到最后的关键注册语句是window.SetValue，它注册的是一个<code>CefV8Value</code>对象，所以CLR对象在注册之前需要进行数据类型转换</strong><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">BindingHandler</span>:<span class="title">CefV8Handler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 绑定数据并注册对象</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 说明：已经过滤特殊名称，即不含系统自动生成的属性、方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=”name”&gt;</span>对象名称<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=”obj”&gt;</span>需要绑定的对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=”window”&gt;</span>用于注册的V8 JS引擎对象，类似于整个程序的窗口句柄<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Bind</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">int</span> hashcode, CefV8Value window, CefBrowser browser</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 把CLR对象用UnmanagedWrapper包装，方便参数传递，就好像CLR中的ref</span></span><br><span class="line">        <span class="keyword">var</span> unmanagedWrapper = <span class="keyword">new</span> UnmanagedWrapper(hashcode);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> propertyAccessor = <span class="keyword">new</span> PropertyAccessor();</span><br><span class="line">        CefV8Value javascriptWrapper = CefV8Value.CreateObject(propertyAccessor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将unmanagedWrapper作为javascriptWrapper的数据</span></span><br><span class="line">        javascriptWrapper.SetUserData(unmanagedWrapper);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义一个V8Handler，真正注册的时候使用</span></span><br><span class="line">        <span class="keyword">var</span> handler = <span class="keyword">new</span> BindingHandler();</span><br><span class="line">        handler.OnSendExecuteMsgHandler -= browser.SendProcessMessage;</span><br><span class="line">        handler.OnSendExecuteMsgHandler += browser.SendProcessMessage;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取CLR对象的属性，并打包到javascriptWrapper中</span></span><br><span class="line">        unmanagedWrapper.Properties = CefRenderRuntime.GetProperties(name,hashcode);</span><br><span class="line">        CreateJavascriptProperties(handler, javascriptWrapper, unmanagedWrapper.Properties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取CLR对象的方法，并打包到javascriptWrapper中</span></span><br><span class="line">        List&lt;<span class="keyword">string</span>&gt; methodNames = CefRenderRuntime.GetMethods(name, hashcode);</span><br><span class="line">        CreateJavascriptMethods(handler, javascriptWrapper, methodNames);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最终注册的是一个javascriptWrapper的CefV8Value，其内容以键值对的方式存在</span></span><br><span class="line">        window.SetValue(name, javascriptWrapper, CefV8PropertyAttribute.None);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建JavaScript方法</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=”handler”&gt;</span>处理程序<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=”javascriptObject”&gt;</span>经过V8 JS引擎处理后的对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=”methodNames”&gt;</span>方法键值对集合<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateJavascriptMethods</span>(<span class="params">CefV8Handler handler, CefV8Value javascriptObject, List&lt;String&gt; methodNames</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> unmanagedWrapper = (UnmanagedWrapper)(javascriptObject.GetUserData());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">string</span> methodName <span class="keyword">in</span> methodNames)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> jsMethodName = StringUtil.LowercaseFirst(methodName);</span><br><span class="line">            unmanagedWrapper.AddMethodMapping(jsMethodName, methodName);</span><br><span class="line">            <span class="keyword">string</span> nameStr = jsMethodName;</span><br><span class="line">            <span class="comment">// 键值对：[方法名，方法，None]</span></span><br><span class="line">            javascriptObject.SetValue(nameStr, CefV8Value.CreateFunction(nameStr, handler), CefV8PropertyAttribute.None);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 根据属性设定javascriptObject</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="handler"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="javascriptObject"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="properties"&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CreateJavascriptProperties</span>(<span class="params">CefV8Handler handler, CefV8Value javascriptObject, Dictionary&lt;<span class="keyword">string</span>,Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;&gt; properties</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> unmanagedWrapper = (UnmanagedWrapper)(javascriptObject.GetUserData());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> propertyInfo <span class="keyword">in</span> properties.Values)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">string</span> propertyName = propertyInfo[<span class="string">"propertyName"</span>];</span><br><span class="line">            <span class="keyword">string</span> jsPropertyName = StringUtil.LowercaseFirst(propertyName);</span><br><span class="line">            unmanagedWrapper.AddPropertyMapping(jsPropertyName, propertyName);</span><br><span class="line">            <span class="keyword">string</span> nameStr = jsPropertyName;</span><br><span class="line">            CefV8PropertyAttribute propertyAttribute = (CefV8PropertyAttribute)(<span class="keyword">int</span>.Parse(propertyInfo[<span class="string">"propertyAttribute"</span>]));</span><br><span class="line">            <span class="comment">// 键值对：[属性名，存取控制，None|Readonly]</span></span><br><span class="line">            javascriptObject.SetValue(nameStr, CefV8AccessControl.Default, propertyAttribute);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>(6)写一个网页，去前台通过JS调用，例如网页那边调用：myHandle.myFunction ()<br>首先在Render进程中触发<code>BindingHandler</code>的<code>Execute</code>方法，该方法解析JS传递进来的方法名，参数列表（TypeUtil将V8数据类型转换为CLR数据类型），之后将解析到的数据打包发送给Browser进程。<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">BindingHandler</span>:<span class="title">CefV8Handler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">Execute</span>(<span class="params"><span class="keyword">string</span> name, CefV8Value obj, CefV8Value[] arguments, <span class="keyword">out</span> CefV8Value returnValue, <span class="keyword">out</span> <span class="keyword">string</span> exception</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 设置默认的返回值和异常值</span></span><br><span class="line">        returnValue = CefV8Value.CreateNull();</span><br><span class="line">        result = <span class="keyword">string</span>.Empty ;</span><br><span class="line">        exception = <span class="keyword">string</span>.Empty;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直接把注册进去的unmanagedWrapper传递到这里，属性和方法都可以从这里拿到</span></span><br><span class="line">        UnmanagedWrapper unmanagedWrapper = obj.GetUserData() <span class="keyword">as</span> UnmanagedWrapper;</span><br><span class="line">        <span class="keyword">int</span> hashcode = unmanagedWrapper.GetHashCode();</span><br><span class="line">        <span class="keyword">if</span> (hashcode == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            exception = <span class="string">"Binding's CLR object is null."</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据调用的方法名name直接拿到对应的CLR对象的真正的方法名</span></span><br><span class="line">        <span class="keyword">string</span> methodName = unmanagedWrapper.GetMethodMapping(name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取从js中传递过来的参数，需要类型转换（TypeUtil.ConvertFromCef）</span></span><br><span class="line">        <span class="keyword">var</span> suppliedArguments = <span class="keyword">new</span> <span class="keyword">object</span>[arguments.Length];</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; suppliedArguments.Length; i++)</span><br><span class="line">                suppliedArguments[i] = TypeUtil.ConvertFromCefV8Value(arguments[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception err)</span><br><span class="line">        &#123;</span><br><span class="line">            exception = err.Message;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拿到真正的方法名之后将对象的哈希值，方法名和参数发送给Browser进程</span></span><br><span class="line">        CefProcessMessage msg = CefProcessMessage.Create(<span class="string">"ExecuteMehtod"</span>);</span><br><span class="line">        CefListValue args = msg.Arguments;</span><br><span class="line">        args.SetInt(<span class="number">0</span>, hashcode);</span><br><span class="line">        args.SetString(<span class="number">1</span>, methodName);</span><br><span class="line">        SetArguments(suppliedArguments,<span class="keyword">ref</span> args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.OnSendExecuteMsgHandler != <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">this</span>.OnSendExecuteMsgHandler(CefProcessId.Browser, msg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 阻塞等待返回值和异常值</span></span><br><span class="line">        BindingHandler.signal.WaitOne();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">string</span>.IsNullOrEmpty(BindingHandler.exception))</span><br><span class="line">        &#123;</span><br><span class="line">            exception = BindingHandler.exception;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        returnValue = TypeUtil.ConvertToCefV8Value(BindingHandler.result, BindingHandler.result.GetType());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>（7）Browser进程中的<code>OnProcessMessageReceived</code>方法接受到Render进程执行方法的消息，首先将方法名参数解析出来，然后调用<code>BindingHandler</code>的<code>ExecuteMethod</code>方法，最后将方法返回值发送给Render进程。<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WebView</span> : <span class="title">WpfCefBrowser</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">OnProcessMessageReceived</span>(<span class="params">CefBrowser browser, CefProcessId sourceProcess, CefProcessMessage message</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 接收到JS执行结果消息</span></span><br><span class="line">        <span class="keyword">if</span> (message.Name == <span class="string">"EvaluteJavaScriptResult"</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 解析处理结果</span></span><br><span class="line">            <span class="keyword">this</span>.exceptionMessage = message.Arguments.GetString(<span class="number">0</span>);</span><br><span class="line">            CefBinaryValue binaryValue = message.Arguments.GetBinary(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] binaryData = binaryValue.ToArray();</span><br><span class="line">            <span class="keyword">this</span>.result = SerializationUtil.DeserializeObject(binaryData);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送处理完毕信号</span></span><br><span class="line">            signal.Set();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 接收到Render发送的对象的哈希值、方法名和参数列表</span></span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (message.Name == <span class="string">"ExecuteMehtod"</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            CefListValue args = message.Arguments;</span><br><span class="line">            <span class="keyword">int</span> hashcode = args.GetInt(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">string</span> methodName = args.GetString(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 参数列表</span></span><br><span class="line">            <span class="keyword">object</span>[] arguments = <span class="keyword">new</span> <span class="keyword">object</span>[args.Count<span class="number">-2</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; args.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> type = args.GetValueType(i);</span><br><span class="line">                <span class="keyword">if</span> (type == CefValueType.Bool)</span><br><span class="line">                    arguments[i<span class="number">-2</span>] = args.GetBool(i);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (type == CefValueType.Int)</span><br><span class="line">                    arguments[i<span class="number">-2</span>] = args.GetInt(i);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (type == CefValueType.Double)</span><br><span class="line">                    arguments[i<span class="number">-2</span>] = args.GetDouble(i);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (type == CefValueType.String)</span><br><span class="line">                    arguments[i<span class="number">-2</span>] = args.GetString(i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据对象的哈希值获取对象</span></span><br><span class="line">            <span class="keyword">var</span> obj = CefGlueRuntime.ObjectList[hashcode];</span><br><span class="line">            </span><br><span class="line">            BindingHandler.ExecuteMethod(obj, methodName, arguments);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 方法执行结束后把结果发送给Render进程</span></span><br><span class="line">            CefProcessMessage msg = CefProcessMessage.Create(<span class="string">"ExecuteMethodResult"</span>);</span><br><span class="line">                CefListValue retargs = msg.Arguments;</span><br><span class="line">                retargs.SetString(<span class="number">0</span>, BindingHandler.exception);</span><br><span class="line">                <span class="keyword">byte</span>[] serializeObj = SerializationUtil.SerializeObject(BindingHandler.result);</span><br><span class="line">                retargs.SetBinary(<span class="number">1</span>, CefBinaryValue.Create(serializeObj));</span><br><span class="line">                <span class="keyword">this</span>.SendProcessMessage(CefProcessId.Renderer, msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>BindingHandler</code>的<code>ExecuteMethod</code>方法如下，它首先调用<code>FindBestMethod</code>匹配最合适的方法，匹配成功后进行Invoke调用</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法执行的这个过程是在Browser进程里执行的</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecuteMethod</span>(<span class="params"><span class="keyword">object</span> obj, <span class="keyword">string</span> methodName, <span class="keyword">object</span>[] suppliedArguments</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 一个对象的方法可能会被重载，所以根据方法名获取到的方法可能会有多个</span></span><br><span class="line">    <span class="keyword">var</span> type = obj.GetType();</span><br><span class="line">    <span class="keyword">var</span> methods = type.GetMember(methodName, MemberTypes.Method, BindingFlags.Instance | BindingFlags.Public);</span><br><span class="line">    <span class="keyword">if</span> (methods.Length == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        BindingHandler.exception = <span class="string">"No method named "</span> + methodName + <span class="string">"."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过反射寻找最合适的方法和参数列表</span></span><br><span class="line">    MethodInfo bestMethod = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">object</span>[] bestMethodArguments = <span class="literal">null</span>;</span><br><span class="line">    FindBestMethod(methods, suppliedArguments, <span class="keyword">ref</span> bestMethod, <span class="keyword">ref</span> bestMethodArguments);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到最好的方法和参数列表，然后进行调用，并且把返回值转换为CefV8Value对象（TypeUtil.ConvertToCef）</span></span><br><span class="line">    <span class="keyword">if</span> (bestMethod != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">object</span> result = bestMethod.Invoke(obj, bestMethodArguments);</span><br><span class="line">            <span class="keyword">if</span>(result != <span class="literal">null</span>)</span><br><span class="line">                BindingHandler.result = TypeUtil.ConvertToCefV8Value(result, bestMethod.ReturnType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (TargetInvocationException err)</span><br><span class="line">        &#123;</span><br><span class="line">            BindingHandler.exception = err.Message;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            BindingHandler.exception = e.Message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        BindingHandler.exception = <span class="string">"Argument mismatch for method \""</span> + methodName + <span class="string">"\"."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而匹配最佳方法<code>FindBestMethod</code>的逻辑如下：<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">FindBestMethod</span>(<span class="params">MemberInfo[] methods, <span class="keyword">object</span>[] suppliedArguments, <span class="keyword">ref</span> MethodInfo bestMethod,<span class="keyword">ref</span> <span class="keyword">object</span>[] bestMethodArguments</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> bestMethodCost = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 逐个遍历方法，然后进行参数匹配</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methods.Length; i++)</span><br><span class="line">    &#123;                </span><br><span class="line">        MethodInfo method = methods[i] <span class="keyword">as</span> MethodInfo;</span><br><span class="line">        <span class="keyword">var</span> parametersInfo = method.GetParameters();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果传递过来的参数个数 == 遍历中的方法的参数列表 == 0，则直接返回（没有参数的情况）</span></span><br><span class="line">        <span class="keyword">if</span> (parametersInfo.Length == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (suppliedArguments.Length == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                bestMethod = method;</span><br><span class="line">                bestMethodArguments = suppliedArguments;</span><br><span class="line">                bestMethodCost = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果二者的参数个数不为0，则进行匹配</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> failed = <span class="number">0</span>; </span><br><span class="line">            <span class="keyword">int</span> cost = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 存放转换后的参数（把）</span></span><br><span class="line">            <span class="keyword">var</span> arguments = <span class="keyword">new</span> List&lt;<span class="keyword">object</span>&gt;();</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// p跟踪方法的参数，a跟踪传递过来的参数</span></span><br><span class="line">                <span class="keyword">int</span> p, a;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (p = <span class="number">0</span>, a = <span class="number">0</span>; failed==<span class="number">0</span> &amp;&amp; p &lt; parametersInfo.Length &amp;&amp; a &lt; suppliedArguments.Length; p++)</span><br><span class="line">                &#123;</span><br><span class="line">                    ParameterInfo pi = parametersInfo[p];</span><br><span class="line">                    Type paramType = pi.ParameterType;</span><br><span class="line">                    <span class="comment">// 如果参数是一个数组，且元素的类型是对象（该情况还未测试）</span></span><br><span class="line">                    <span class="keyword">if</span> (paramType.IsArray &amp;&amp; paramType.GetElementType() == <span class="keyword">typeof</span>(<span class="keyword">object</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 该情况只能是最后一个参数，否则匹配失败</span></span><br><span class="line">                        <span class="keyword">if</span> (p &lt; parametersInfo.Length - <span class="number">1</span>)&#123;</span><br><span class="line">                            failed++;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//将剩余的参数作为一个数组添加到arguments中</span></span><br><span class="line">                        <span class="keyword">var</span> parm = <span class="keyword">new</span> List&lt;<span class="keyword">object</span>&gt;();</span><br><span class="line">                        <span class="keyword">for</span> (; a &lt; suppliedArguments.Length; a++)</span><br><span class="line">                            parm.Add(suppliedArguments[a]);</span><br><span class="line">                        arguments.Add(parm.ToArray());</span><br><span class="line">                        cost += arguments.Count * <span class="number">2</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 如果是非集合类型，直接计算类型转换代价</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 计算类型转换代价</span></span><br><span class="line">                        <span class="keyword">int</span> paramCost = TypeUtil.GetChangeTypeCost(suppliedArguments[a], paramType);</span><br><span class="line">                        <span class="comment">// 代价为负，说明类型无法转换</span></span><br><span class="line">                        <span class="keyword">if</span> (paramCost &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                            failed++;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 把转换好的参数添加到arguments中</span></span><br><span class="line">                        arguments.Add(TypeUtil.ChangeType(suppliedArguments[a++], paramType));</span><br><span class="line">                        cost += paramCost;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                failed++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过上述匹配过程确定最佳方法和参数列表</span></span><br><span class="line">            <span class="keyword">if</span> (failed &gt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;                    </span><br><span class="line">            <span class="keyword">if</span> (cost &lt; bestMethodCost || bestMethodCost &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                bestMethod = method;</span><br><span class="line">                bestMethodArguments = arguments.ToArray();</span><br><span class="line">                bestMethodCost = cost;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cost == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>文章中提到了两个问题：<br>第一个是编译CEF内核，需要有点耐心，多一点坚持，<br>第二个是支持JS调用Native功能，抓住以下两条路径就可以理顺。<br>(1)注册路径：CLR对象–&gt;Browser进程保存–&gt;反射解析方法名和参数–&gt;发送给Render进程–&gt;使用BindingHandle在V8引擎注册<br>(2)调用路径：H5中调用–&gt;Render进程的Execute解析方法名和参数–&gt;发送消息给Browser进程–&gt;Browser进程调用BindingHandle的ExecuteMethod方法–&gt;返回值发送给Render进程</p>

      
    </div>
    
    
    

    
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束 感谢您的阅读-------------</div>
    
</div>

      <div>
    

    
      <div>
        
<div class="my_post_copyright">
  <script src="//s0.pstatp.com/cdn/expire-1-M/clipboard.js/1.5.10/clipboard.min.js"></script>
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://s1.pstatp.com/cdn/expire-1-M/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2018/05/26/CEFGlue之回忆篇/">CEFGlue之回忆篇</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 lingyun 的个人博客">lingyun</a></p>
  <p><span>发布时间:</span>2018年05月26日 - 01:05</p>
  <p><span>最后更新:</span>2018年06月04日 - 00:06</p>
  <p><span>原始链接:</span><a href="/2018/05/26/CEFGlue之回忆篇/" title="CEFGlue之回忆篇">https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
  });
    });  
</script>


      <div>
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="lingyun 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="lingyun 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        
<div class="my_post_copyright">
  <script src="//s0.pstatp.com/cdn/expire-1-M/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://s1.pstatp.com/cdn/expire-1-M/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2018/05/26/CEFGlue之回忆篇/">CEFGlue之回忆篇</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 lingyun 的个人博客">lingyun</a></p>
  <p><span>发布时间:</span>2018年05月26日 - 01:05</p>
  <p><span>最后更新:</span>2018年06月04日 - 00:06</p>
  <p><span>原始链接:</span><a href="/2018/05/26/CEFGlue之回忆篇/" title="CEFGlue之回忆篇">https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://tsuijunxi.github.io/2018/05/26/CEFGlue之回忆篇/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
  });
    });  
</script>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CEF-Chromium/" rel="tag"># CEF Chromium</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/10/GCD源码分析6 —— dispatch-source篇/" rel="next" title="GCD源码分析6 —— dispatch_source篇">
                <i class="fa fa-chevron-left"></i> GCD源码分析6 —— dispatch_source篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/09/如何实现一个简单的RunLoop（1）/" rel="prev" title="如何去实现一个轻量级的Runloop（1）">
                如何去实现一个轻量级的Runloop（1） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/favicon.ico"
                alt="lingyun" />
            
              <p class="site-author-name" itemprop="name">lingyun</p>
              <p class="site-description motion-element" itemprop="description">Stay Hungry, Stay Foolish</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">2.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CEF支持音视频"><span class="nav-number">3.</span> <span class="nav-text">CEF支持音视频</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CEF内核编译流程"><span class="nav-number">3.1.</span> <span class="nav-text">CEF内核编译流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CEF内核的H5评估得分"><span class="nav-number">3.2.</span> <span class="nav-text">CEF内核的H5评估得分</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JS调用Native功能"><span class="nav-number">4.</span> <span class="nav-text">JS调用Native功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#官方原生注册方法"><span class="nav-number">4.1.</span> <span class="nav-text">官方原生注册方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高级注册方法"><span class="nav-number">4.2.</span> <span class="nav-text">高级注册方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#注册核心原理洞悉"><span class="nav-number">4.2.1.</span> <span class="nav-text">注册核心原理洞悉</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多进程通信解决方案"><span class="nav-number">4.2.2.</span> <span class="nav-text">多进程通信解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#全自动反射注册"><span class="nav-number">4.2.3.</span> <span class="nav-text">全自动反射注册</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lingyun</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">133.0k</span>

  <div class="powered-by">
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_pv">
      本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>|
    <i class="fa fa-eye-md"></i>
    <span id="busuanzi_container_site_uv">
      本站访客数:<span id="busuanzi_value_site_uv"></span>人
    </span>

  </div>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="/js/src/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '3b98a5ec68bfccc21c29',
          clientSecret: '4c30086ddf0fdf77d050830b540bcffd3054c1b0',
          repo: 'tsuijunxi.github.io',
          owner: 'tsuijunxi',
          admin: ['tsuijunxi'], 
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>


  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
